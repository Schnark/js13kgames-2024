<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<title>The Lairs of Bad Luck</title>
<meta name="viewport" content="width=device-width">
<style>
html{font-family:sans-serif}#canvas{image-rendering:-moz-crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;image-rendering:pixelated;cursor:pointer}#log{overflow-y:scroll;height:4.5em;line-height:1.5em}#log li{display:block}.mushroom{cursor:pointer}</style>
</head><body>
<ol id="log" reversed></ol>
<canvas id="canvas" moz-opaque></canvas>
<p>Luck: <span id="luck"></span><br>
<canvas id="luck-canvas" moz-opaque></canvas></p>
<p id="inv"></p>
<section>
<h2>Help</h2>
<p>Use number pad to move (or arrow keys but without diagonal movement), hold shift to walk to next wall. Or click on a place to go to (if you have seen it before).</p>
<p>To climb up and down ladders use &lt; and &gt;. Or just click on it.</p>
<p>Press x to automatically explore the map.</p>
<p>Press w to wait a turn, or W to wait until you see an enemy.</p>
<p>To attack an enemy, press f for a ranged attack, or walk into it for a melee attack. Or just click on it.</p>
<p>Press e to eat a mushroom, or click it in your inventory.</p>
</section>
<script>
(function(){var i,u,v,w,x,y,s,t,z,A;i=function(){function b(c){var b;e?j.push(c):(b=document.createElement("li"),b.textContent=c.charAt(0).toUpperCase()+c.slice(1),a.insertBefore(b,a.firstChild))}var a=document.getElementById("log"),j=[],e=!1;b.async=function(a){e=a};b.clearQueue=function(){j.forEach(function(a){b(a)});j=[]};return b}();u=function(){function b(a,j){a=Math.ceil(a);j=Math.floor(j);return Math.floor(a+Math.random()*(j+1-a))}function a(a,j,d,g){function k(a,j){var f,b;for(f=0;f<a.w;f++)for(b=
0;b<a.h;b++)o[b+a.y+1][f+a.x+1]=j}var l,f,q,o=[];for(f=0;f<c+2;f++){q=[];for(l=0;l<e+2;l++)q.push("#");o.push(q)}for(f=0;f<j.length;f++)k(j[f]," ");for(f=0;f<a.length;f++)k(a[f],".");o[g+1][d+1]="<";f=a.length===1?0:b(1,a.length-1);l=b(0,a[f].w-1)+a[f].x;f=b(0,a[f].h-1)+a[f].y;o[f+1][l+1]=">";return o.map(function(a){return a.join("")}).join("\n")}function j(a,j,c){var e,d,l;Math.random()<0.5?(e=a,a=j):e=j;for(j=0;j<m;j++){d=2*b(e.x/2,(e.x+e.w-1)/2);l=2*b(a.y/2,(a.y+a.h-1)/2);var f;a:{f=c;for(var q=
d,o=l,n=void 0,n=0;n<f.length;n++)if((q===f[n].x-1||q===f[n].x+f[n].w)&&f[n].y-1<=o&&o<=f[n].y+f[n].h||(o===f[n].y-1||o===f[n].y+f[n].h)&&f[n].x-1<=q&&q<=f[n].x+f[n].w){f=!0;break a}f=!1}if(!f)break}c={x:d,y:Math.min(e.y,l),w:1,h:Math.abs(e.y-l)+1};d={x:Math.min(a.x,d),y:l,w:Math.abs(a.x-d)+1,h:1};return[c,d]}var e=50,c=20,d=0.3*e*c,m=1E4;return function(h,m){h===-1?(h=b(0,e-1),m=b(0,c-1)):(h--,m--);var i=[],g,k,l;a:{g=h;l=m;var f;for(k=0;k<1E4;k++)if(f={x:b(0,g),y:b(0,l),w:b(4,12),h:b(4,8)},f.x+
f.w<=e&&f.y+f.h<=c&&f.x+f.w>g&&f.y+f.h>l){k=f;break a}k={x:g,y:l,w:1,h:1}}l=k.w*k.h;i.push(k);for(g=0;g<1E4;g++){a:{k=i;var q=f=void 0;f={x:b(0,e-4),y:b(0,c-4),w:b(4,12),h:b(4,8)};if(!(f.x+f.w>e)&&!(f.y+f.h>c)){for(q=0;q<k.length;q++){var o;o=k[q];var n=f;o=Math.abs(o.x-n.x)>(o.x<n.x?o.w:n.w)?!1:Math.abs(o.y-n.y)>(o.y<n.y?o.h:n.h)?!1:!0;if(o){k=void 0;break a}}k=f}else k=void 0}if(k&&(l+=k.w*k.h,i.push(k),l>=d))break}l=[];for(g=1;g<i.length;g++)l=l.concat(j(i[b(0,g-1)],i[g],i));return a(i,l,h,m)}}();
v=function(){function b(a){this.canvas=document.getElementById(a);this.ctx=this.canvas.getContext("2d",{alpha:!1});this.f=1.5}b.prototype.setSize=function(a,j){if(this.canvas.width!==a*16)this.canvas.width=a*16,this.canvas.style.width=a*16*this.f+"px";if(this.canvas.height!==j*16)this.canvas.height=j*16,this.canvas.style.height=j*16*this.f+"px"};b.prototype.getTile=function(a,j){a=(a-this.canvas.offsetLeft+document.documentElement.scrollLeft)/this.f;j=(j-this.canvas.offsetTop+document.documentElement.scrollTop)/
this.f;a=Math.floor(a/16);j=Math.floor(j/16);return[a,j]};return b}();w=function(){function b(a){this.type=a;this.seen=!1}b.draw={".":function(a){a.fillStyle="rgba(128,128,128,0.75)";a.fillRect(0,0,16,16)}," ":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16)},"#":function(a){a.fillStyle="brown";a.fillRect(0,0,16,16)},">":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16);a.strokeStyle="brown";a.beginPath();a.moveTo(7.5,2);a.lineTo(7.5,14);a.lineTo(3.5,10);a.lineTo(11.5,10);a.lineTo(7.5,14);
a.stroke()},"<":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16);a.strokeStyle="brown";a.beginPath();a.moveTo(7.5,14);a.lineTo(7.5,2);a.lineTo(3.5,6);a.lineTo(11.5,6);a.lineTo(7.5,2);a.stroke()},"%":function(a){a.fillStyle="#8f8";a.fillRect(0,0,16,16)},F:function(a){a.fillStyle="#f88";a.fillRect(0,0,16,16)},"(":function(a){a.fillStyle="#f80";a.fillRect(0,0,16,16)},"*":function(a){a.fillStyle="#ff0";a.fillRect(0,0,16,16)}};b.prototype.draw=function(a,j){if(j)this.seen=!0;if(this.seen&&(b.draw[this.type](a.ctx),
!j))b.draw["."](a.ctx)};b.prototype.isOpen=function(){return this.type!=="#"};b.prototype.isSeen=function(){return this.seen};b.prototype.getType=function(){return this.type};b.prototype.takeItem=function(){this.type=" "};return b}();x=function(){function b(a,b){this.tiles=a.split("\n").map(function(a){return a.split("").map(function(a){return new w(a)})});this.npc=[];this.depth=b}function a(a,b,c,d,m){function h(c,f,d){for(var c={x:c,y:f,prev:d,g:d?d.g+1:0,h:Math.max(Math.abs(c-a),Math.abs(f-b))},
g,d=c.g+c.h,f=0;f<i.length;f++)if(g=i[f].g+i[f].h,d<g||d===g&&c.h<i[f].h){i.splice(f,0,c);return}i.push(c)}var i=[],r={},g,k;for(h(c,d);i.length;)if(c=i.shift(),d=c.x+","+c.y,!r[d]){r[d]=c;if(c.x===a&&c.y===b)break;g=m(c.x,c.y);for(k=0;k<g.length;k++)d=g[k][0]+","+g[k][1],r[d]||h(g[k][0],g[k][1],c)}if(c=r[a+","+b]){for(m=[];c;)m.push([c.x,c.y]),c=c.prev;return m}}b.prototype.draw=function(a,b){var c=this.tiles.length,d=this.tiles[0].length,m,h,p=!1;a.setSize(d,c);a.ctx.fillStyle="#000";a.ctx.fillRect(0,
0,d*16,c*16);for(m=0;m<d;m++)for(h=0;h<c;h++)a.ctx.save(),a.ctx.translate(m*16,h*16),this.tiles[h][m].draw(a,b.canSee(m,h)),a.ctx.restore();this.visibleMonsters=[];for(c=0;c<this.npc.length;c++)d=this.npc[c],m=d.x,h=d.y,b.canSee(m,h)?(a.ctx.save(),a.ctx.translate(m*16,h*16),d.draw(a),a.ctx.restore(),d.seen||i(d.seenBefore?"you see "+d.getDesc(!0)+" again.":"you see "+d.getDesc()+"."),d.seen=!0,p=d.seenBefore=!0,this.visibleMonsters.push(d)):d.seen=!1;a.ctx.save();a.ctx.translate(b.x*16,b.y*16);b.draw(a);
a.ctx.restore();b.showLuck();return p};b.prototype.isOpen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isOpen()};b.prototype.hasBeenSeen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isSeen()};b.prototype.getType=function(a,b){return this.tiles[b][a].getType()};b.prototype.takeItem=function(a,b){return this.tiles[b][a].takeItem()};b.prototype.monsterAt=function(a,b){var c,d;for(c=0;c<this.npc.length;c++)if(d=
this.npc[c],d.x===a&&d.y===b)return d};b.prototype.findFirst=function(a){var b,c;for(b=0;b<this.tiles[0].length;b++)for(c=0;c<this.tiles.length;c++)if(this.tiles[c][b].getType()===a)return[b,c]};b.prototype.findFreeTile=function(a){var b,c,d;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*this.tiles[0].length),d=Math.floor(Math.random()*this.tiles.length),this.isOpen(c,d)&&!this.monsterAt(c,d)&&!a.canSee(c,d))return[c,d]};b.prototype.spawnMonster=function(a,b){var c;if(b||!(Math.random()>0.05)){if(b&&
this.depth===2)c=this.findFirst("<"),this.isOpen(c[0]-1,c[1])?c[0]--:c[0]++,c=new t("A",c[0],c[1],this),c.aiMode="hint",c.block=1,this.npc.push(c);if(c=this.findFreeTile(a))c=new t("x",c[0],c[1],this),this.npc.push(c)}};b.prototype.removeMonster=function(a){this.npc.splice(this.npc.indexOf(a),1)};b.prototype.leave=function(){var a;for(a=0;a<this.npc.length;a++)this.npc[a].seen=!1};b.prototype.findPath=function(b,e,c,d,i){var h=this;return a(b,e,c,d,function(a,b){return[[-1,0],[1,0],[0,-1],[0,1],[-1,
-1],[1,-1],[-1,1],[1,1]].map(function(c){return[a+c[0],b+c[1]]}).filter(function(a){return h.isOpen(a[0],a[1])&&(!i||h.hasBeenSeen(a[0],a[1]))})})};b.prototype.autoexplore=function(a){var b=Infinity,c,d,i,h,p;for(h=0;h<this.tiles[0].length;h++)for(p=0;p<this.tiles.length;p++)this.isOpen(h,p)&&!this.hasBeenSeen(h,p)&&(i=Math.max(Math.abs(a.x-h),Math.abs(a.y-p)),i<b&&(c=h,d=p,b=i));if(b!==Infinity&&(a=this.findPath(a.x,a.y,c,d))){for(b=0;b<a.length;b++)if(!this.hasBeenSeen(a[b][0],a[b][1])){a.length=
b+1;break}return a}};return b}();y=function(){function b(){this.levels=[this.createLevel(3,3,0)];this.currentLevel=0}b.prototype.init=function(a){a.x=3;a.y=3;a.level=this.levels[0];this.levels[0].spawnMonster(a,!0)};b.prototype.createLevel=function(a,b,e){function c(a){var b,c;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*d.length),d.charAt(c)===".")return d=d.slice(0,c)+a+d.slice(c+1),!0}var d=u(a,b);c("*");c("%");c("%");c("%");c("F");c("F");e===1&&c("(");d=d.replace(/\./g," ");e===0?d=d.replace("<",
" "):e===2&&(d=d.replace(">"," "));return new x(d,e)};b.prototype.goUp=function(a){i("you climb up the ladder.");this.levels[this.currentLevel].leave();this.currentLevel--;a.level=this.levels[this.currentLevel]};b.prototype.goDown=function(a){var b;i("you climb down the ladder.");this.levels[this.currentLevel].leave();this.currentLevel++;this.levels[this.currentLevel]||(b=this.createLevel(a.x,a.y,this.currentLevel),this.levels.push(b));a.level=this.levels[this.currentLevel];b&&b.spawnMonster(a,!0)};
return b}();s=function(){function b(){}b.draw={"@":function(a){a.fillStyle="blue";a.fillRect(4,4,8,8)},x:function(a){a.fillStyle="green";a.fillRect(4,4,8,8)},A:function(a){a.fillStyle="black";a.fillRect(4,4,8,8)}};b.prototype.drawHealth=function(a,b,e){var c=this.health/this.maxHealth,d;d="hsl("+Math.round(140*c*c)+",100%,30%)";a.fillStyle=d;a.fillRect(0,0,b,e);a.fillStyle="#000";c=Math.round((b-2)*(1-c));a.fillRect(b-c-1,1,c,e-2);return d};b.prototype.draw=function(a){b.draw[this.type](a.ctx);!this.isPlayer&&
this.health<this.maxHealth&&(a.ctx.translate(2,2),this.drawHealth(a.ctx,12,4))};b.prototype.moveTo=function(a,b){var e;this.x=a;this.y=b;this.isPlayer&&(e=this.level.getType(a,b),e!==" "&&(e=this.handleItem(e))&&this.level.takeItem(a,b))};b.prototype.moveRel=function(a,b){var e=this.x+a,c=this.y+b,d;if(d=this.level.monsterAt(e,c))return this.attack(d),!0;return this.level.isOpen(e,c)?(this.moveTo(e,c),!0):!1};b.prototype.rangedFails=function(a){return Math.random()<(Math.pow(1.5,a/2)-1)/this.experience};
b.prototype.blockAttack=function(){return Math.random()<this.block*this.experience};b.prototype.getAttackDamage=function(){return Math.round((this.minAttack+Math.random()*(this.maxAttack-this.minAttack))*this.experience)};b.prototype.improveExperience=function(a){a=this.experience*Math.pow(2,a/500);Math.floor(a*10)!==Math.floor(this.experience*10)&&i("you feel more experienced now.");this.experience=a};b.prototype.attack=function(a,b){function e(a,b){var j=a.x-b.x,h=a.y-b.y;return Math.sqrt(j*j+h*
h)}if(a.health!==0)if(b&&this.rangedFails(e(a,this)))this.isPlayer?i("you try to hit "+a.getDesc(!0)+", but miss."):i(this.getDesc(!0)+" tries to hit you, but misses.");else if(a.blockAttack())this.isPlayer?i("you try to hit "+a.getDesc(!0)+", but your attack is blocked."):i(this.getDesc(!0)+" tries to hit you, but you block the attack.");else if(this.isPlayer?i("you hit "+a.getDesc(!0)+"."):i(this.getDesc(!0)+" hits you."),a.health-=this.getAttackDamage(),a.health<=0)a.health=0,a.die(),this.isPlayer&&
this.improveExperience(a.maxHealth)};b.prototype.die=function(){this.isPlayer?i("you are out of luck and lose the game."):(i(this.getDesc(!0)+" vanishes."),this.level.removeMonster(this))};return b}();t=function(){function b(a,b,e,c){this.type=a;this.x=b;this.y=e;this.level=c;this.seenBefore=this.seen=!1;this.maxHealth=this.health=10;this.experience=1;this.block=0.1;this.minAttack=1;this.maxAttack=2}b.prototype=new s;b.desc={x:["a green monster","the green monster"],A:["a chimney sweep","the chimney sweep"]};
b.prototype.getDesc=function(a){return b.desc[this.type][a?1:0]};b.prototype.walkRandom=function(a){var b,e;do b=Math.floor(Math.random()*3)-1,e=Math.floor(Math.random()*3)-1;while(!this.level.isOpen(this.x+b,this.y+e));!this.level.monsterAt(this.x+b,this.y+e)&&!(a.x===this.x+b&&a.y===this.y+e)&&this.moveRel(b,e)};b.prototype.huntPlayer=function(a){var b=this.level.findPath(this.x,this.y,a.x,a.y);!b||b.length<2||this.level.monsterAt(b[1][0],b[1][1])?this.walkRandom(a):this.moveRel(b[1][0]-b[0][0],
b[1][1]-b[0][1])};b.prototype.meleeAI=function(a){Math.abs(a.x-this.x)<=1&&Math.abs(a.y-this.y)<=1?this.attack(a):this.seen?this.huntPlayer(a):this.walkRandom(a)};b.prototype.rangedAI=function(a){this.seen?this.attack(a,!0):Math.random()<0.5?this.walkRandom(a):this.huntPlayer(a)};b.prototype.meleeRangedAI=function(a){var b=a.x-this.x,e=a.y-this.y;Math.abs(b)<=1&&Math.abs(e)<=1?this.attack(a):b*b+e*e<=4?this.attack(a,!0):this.seen?Math.random()<0.5?this.attack(a,!0):this.huntPlayer(a):this.rangedAI(a)};
b.prototype.hintAI=function(a){var b;if(this.seen)b=a.getHint(),this.lastHint!==b?(i(this.getDesc(!0)+": \u201c"+b+"\u201d"),this.lastHint=b):this.walkRandom(a)};b.prototype.monsterAI=function(a){if(this.seenBefore)switch(this.aiMode){case "ranged":this.rangedAI(a);break;case "meleeRanged":this.meleeRangedAI(a);break;case "hint":this.hintAI(a);break;default:this.meleeAI(a)}};return b}();z=function(){function b(a){this.type="@";this.isPlayer=!0;this.dungeon=a;a.init(this);this.sightRadius=3;this.maxHealth=
this.health=77;this.experience=1;this.block=0.1;this.minAttack=1;this.maxAttack=3;this.luckyMushroomTimeout=this.luckyMushrooms=this.luckyCharms=0}b.prototype=new s;b.prototype.showLuck=function(){if(!this.luckOutput)this.luckOutput=document.getElementById("luck"),this.luckCanvas=document.getElementById("luck-canvas").getContext("2d",{alpha:!1}),this.luckCanvas.canvas.width=100,this.luckCanvas.canvas.height=10;this.luckOutput.style.color=this.drawHealth(this.luckCanvas,100,10);this.luckOutput.textContent=
this.health+"/"+this.maxHealth};b.prototype.showInv=function(){var a;a=[this.luckyCharms?this.luckyCharms+" lucky charm(s)":"",this.luckyMushrooms?'<span class="mushroom">'+this.luckyMushrooms+" lucky mushroom(s)</span>":"",this.sightRadius===5?"a lamp":""].filter(function(a){return a}).join(", ");document.getElementById("inv").innerHTML=a?"You have: "+a:""};b.prototype.getHint=function(){return["You should go back, there are two lucky charms above.","You should go back, there is one lucky charm above.",
"Well done so far! Now find the third lucky charm."][this.luckyCharms]};b.prototype.canSee=function(a,b){var e=a-this.x,c=b-this.y,d,i,h;this.level.isOpen(a,b)||(e>0?e-=0.5:e<0&&(e+=0.5),c>0?c-=0.5:c<0&&(c+=0.5));if(e*e+c*c>this.sightRadius*this.sightRadius)return!1;for(d=0;d<this.sightRadius;d++){i=Math.round(this.x+d*e/this.sightRadius);h=Math.round(this.y+d*c/this.sightRadius);if(i===a&&h===b)break;if(!this.level.isOpen(i,h))return!1}return!0};b.prototype.handleItem=function(a){var b=!1;if(a===
"%"){a="you found a four-leave clover, ";if(this.health===this.maxHealth)a+="but you leave it here for later.";else{b=!0;this.health+=7;if(this.health>this.maxHealth)this.health=this.maxHealth;a+="which"+(this.health===this.maxHealth?"":" partially")+" restores your luck."}i(a)}else if(a==="*")this.luckyCharms++,b=!0,i("you found a lucky charm.");else if(a==="F")this.luckyMushrooms++,b=!0,i("you found a lucky mushroom"+(this.luckyMushrooms===1?", which you can eat to make you very strong for a short time":
"")+".");else if(a==="(")b=!0,this.sightRadius=5,i("you found a lamp.");b&&this.showInv();return b};b.prototype.eat=function(){if(this.luckyMushrooms===0)return!1;this.luckyMushrooms--;this.showInv();this.luckyMushroomTimeout===0&&(this.experience*=2,i("you feel very strong!"));this.luckyMushroomTimeout+=Math.floor(4+Math.random()*5);return!0};b.prototype.handleMushroomTimeout=function(){this.luckyMushroomTimeout!==0&&(this.luckyMushroomTimeout--,this.luckyMushroomTimeout===0&&(this.experience/=2,
i("you feel normal again.")))};b.prototype.goUp=function(){if(this.level.getType(this.x,this.y)==="<")return this.dungeon.goUp(this),!0};b.prototype.goDown=function(){if(this.level.getType(this.x,this.y)===">")return this.dungeon.goDown(this),!0};return b}();A=function(){function b(a,b,c){var d;if(c){c=g.x+a;for(d=g.y+b;g.level.isOpen(c,d);)h.push(["move",a,b]),c+=a,d+=b}else h.push(["move",a,b])}function a(a){var b,c,d;for(b=0;b<a.length;b++)b>0&&h.push(["move",a[b][0]-c,a[b][1]-d]),c=a[b][0],d=
a[b][1]}function j(a){var b;for(b=0;b<(a?10:1);b++)h.push(["wait"]);a&&h.push(["autowait"])}function e(a){if(!a.ctrlKey&&!a.altKey){h=[];var c;if(a.key&&a.key!=="Unidentified")c={Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown"}[a.key]||a.key;else if(!(c={12:"Clear",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown"}[a.which])){c=a.shiftKey;var d=String.fromCharCode(a.which).toLowerCase();c&&(d={"<":">"}[d]||d.toUpperCase());c=
d}switch(c){case "1":case "End":b(-1,1,a.shiftKey);break;case "2":case "ArrowDown":b(0,1,a.shiftKey);break;case "3":case "PageDown":b(1,1,a.shiftKey);break;case "4":case "ArrowLeft":b(-1,0,a.shiftKey);break;case "5":case "Clear":case "w":case "W":j(a.shiftKey);break;case "6":case "ArrowRight":b(1,0,a.shiftKey);break;case "7":case "Home":b(-1,-1,a.shiftKey);break;case "8":case "ArrowUp":b(0,-1,a.shiftKey);break;case "9":case "PageUp":b(1,-1,a.shiftKey);break;case "<":h.push(["goUp"]);break;case ">":h.push(["goDown"]);
break;case "e":h.push(["eat"]);break;case "f":h.push(["attack"]);break;case "x":h.push(["autoexplore"])}a.preventDefault();m()}}function c(b){var c,d,e;k||(c=l.getTile(b.clientX,b.clientY),b=c[0],c=c[1],h=[],g.level.hasBeenSeen(b,c)?g.level.isOpen(b,c)?g.canSee(b,c)&&g.level.monsterAt(b,c)?Math.abs(b-g.x)<=1&&Math.abs(c-g.y)<=1?h.push(["move",b-g.x,c-g.y]):h.push(["attack",b,c]):g.x===b&&g.y===c?(d=g.level.getType(b,c),d!=="<"&&d!==">"&&h.push(["wait"])):(d=g.level.getType(b,c),e=g.level.findPath(g.x,
g.y,b,c,!0)):i("you cannot go there."):i("you don\u2019t know how to go there."),e&&a(e),d===">"?h.push(["goDown"]):d==="<"&&h.push(["goUp"]),m())}function d(a){a.target.className==="mushroom"&&(h.push(["eat"]),m())}function m(){var b,c=!1,d,e;for(clearTimeout(p);!c;){if(h.length===0)return;b=h.shift();if(k)return;switch(b[0]){case "move":c=g.moveRel(b[1],b[2]);break;case "goUp":c=g.goUp();break;case "goDown":c=g.goDown();break;case "eat":c=g.eat();break;case "attack":if(b[1])for(d=0;d<g.level.visibleMonsters.length;d++)if(e=
g.level.visibleMonsters[d],e.x===b[1]&&e.y===b[2])break;else e=null;else e=g.level.visibleMonsters[0];e&&(g.attack(e,!0),c=!0);break;case "wait":c=!0;break;case "autowait":i("still waiting, press c to cancel.");j(!0);break;case "autoexplore":(b=g.level.autoexplore(g))?(a(b),h.push(["autoexplore"])):i("level completely explored.")}}i.async(!0);g.level.spawnMonster(g);for(d=0;d<g.level.npc.length;d++)if(e=g.level.npc[d],e.speed)for(e.movesLeft=(e.movesLeft||0)+1;e.movesLeft>=e.speed;)e.monsterAI(g),
e.movesLeft-=e.speed;else e.monsterAI(g);g.handleMushroomTimeout();i.async(!1);c=g.level.draw(l,g);i.clearQueue();c&&(h=[]);g.health===0&&(h=[],k=!0);g.luckyCharms===3&&(i("you found all lucky charms and win the game."),k=!0);h.length>0&&(p=setTimeout(m,r))}var h=[],p,r=200,g,k=!1,l=new v("canvas");return{init:function(a){g=a;document.addEventListener("keydown",e);l.canvas.addEventListener("click",c);document.getElementById("inv").addEventListener("click",d);g.level.draw(l,g);i("welcome. Find all three lucky charms to win.")}}}();
(function(){var b=new y,b=new z(b);A.init(b)})()})();
</script>
</body></html>