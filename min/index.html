<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<title>Untitled game</title>
<meta name="viewport" content="width=device-width">
<style>
html{font-family:sans-serif}#canvas{image-rendering:-moz-crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;image-rendering:pixelated;cursor:pointer}#log{overflow-y:scroll;height:4.5em;line-height:1.5em}#log li{display:block}</style>
</head><body>
<canvas id="canvas" moz-opaque></canvas>
<ol id="log" reversed></ol>
<p>Luck: <span id="luck"></span><br>
<canvas id="luck-canvas" moz-opaque></canvas></p>
<section>
<h2>Help</h2>
<p>Use number pad to move (or arrow keys but without diagonal movement), hold shift to walk to next wall. Or click on a place to go to (if you have seen it before).</p>
<p>To climb up and down ladders use &lt; and &gt;. Or just click on it.</p>
<p>Press x to automatically explore the map.</p>
<p>Press w to wait a turn, or W to wait until you see an enemy.</p>
<p>To attack an enemy, press f for a ranged attack, or walk into it for a melee attack. Or just click on it.</p>
</section>
<script>
(function(){var e,t,u,v,w,x,s,y,z,A;e=function(){function b(b){var d;k?i.push(b):(d=document.createElement("li"),d.textContent=b.charAt(0).toUpperCase()+b.slice(1),a.insertBefore(d,a.firstChild))}var a=document.getElementById("log"),i=[],k=!1;b.async=function(a){k=a};b.clearQueue=function(){i.forEach(function(a){b(a)});i=[]};return b}();t=function(){function b(a,i){a=Math.ceil(a);i=Math.floor(i);return Math.floor(a+Math.random()*(i+1-a))}function a(a,i,d,g){function l(a,f){var i,b;for(i=0;i<a.w;i++)for(b=
0;b<a.h;b++)j[b+a.y+1][i+a.x+1]=f}var m,f,q,j=[];for(f=0;f<c+2;f++){q=[];for(m=0;m<k+2;m++)q.push("#");j.push(q)}for(f=0;f<i.length;f++)l(i[f]," ");for(f=0;f<a.length;f++)l(a[f],".");j[g+1][d+1]="<";f=a.length===1?0:b(1,a.length-1);m=b(0,a[f].w-1)+a[f].x;f=b(0,a[f].h-1)+a[f].y;j[f+1][m+1]=">";return j.map(function(a){return a.join("")}).join("\n")}function i(a,i,k){var c,d,m;Math.random()<0.5?(c=a,a=i):c=i;for(i=0;i<g;i++){d=2*b(c.x/2,(c.x+c.w-1)/2);m=2*b(a.y/2,(a.y+a.h-1)/2);var f;a:{f=k;for(var q=
d,j=m,e=void 0,e=0;e<f.length;e++)if((q===f[e].x-1||q===f[e].x+f[e].w)&&f[e].y-1<=j&&j<=f[e].y+f[e].h||(j===f[e].y-1||j===f[e].y+f[e].h)&&f[e].x-1<=q&&q<=f[e].x+f[e].w){f=!0;break a}f=!1}if(!f)break}k={x:d,y:Math.min(c.y,m),w:1,h:Math.abs(c.y-m)+1};d={x:Math.min(a.x,d),y:m,w:Math.abs(a.x-d)+1,h:1};return[k,d]}var k=50,c=20,d=0.3*k*c,g=1E4;return function(g,e){g===-1?(g=b(0,k-1),e=b(0,c-1)):(g--,e--);var h=[],n,l,m;a:{n=g;m=e;var f;for(l=0;l<1E4;l++)if(f={x:b(0,n),y:b(0,m),w:b(4,12),h:b(4,8)},f.x+
f.w<=k&&f.y+f.h<=c&&f.x+f.w>n&&f.y+f.h>m){l=f;break a}l={x:n,y:m,w:1,h:1}}m=l.w*l.h;h.push(l);for(n=0;n<1E4;n++){a:{l=h;var q=f=void 0;f={x:b(0,k-4),y:b(0,c-4),w:b(4,12),h:b(4,8)};if(!(f.x+f.w>k)&&!(f.y+f.h>c)){for(q=0;q<l.length;q++){var j;j=l[q];var r=f;j=Math.abs(j.x-r.x)>(j.x<r.x?j.w:r.w)?!1:Math.abs(j.y-r.y)>(j.y<r.y?j.h:r.h)?!1:!0;if(j){l=void 0;break a}}l=f}else l=void 0}if(l&&(m+=l.w*l.h,h.push(l),m>=d))break}m=[];for(n=1;n<h.length;n++)m=m.concat(i(h[b(0,n-1)],h[n],h));return a(h,m,g,e)}}();
u=function(){function b(a){this.canvas=document.getElementById(a);this.ctx=this.canvas.getContext("2d",{alpha:!1});this.f=1.5}b.prototype.setSize=function(a,i){if(this.canvas.width!==a*16)this.canvas.width=a*16,this.canvas.style.width=a*16*this.f+"px";if(this.canvas.height!==i*16)this.canvas.height=i*16,this.canvas.style.height=i*16*this.f+"px"};b.prototype.getTile=function(a,i){a=(a-this.canvas.offsetLeft+document.documentElement.scrollLeft)/this.f;i=(i-this.canvas.offsetTop+document.documentElement.scrollTop)/
this.f;a=Math.floor(a/16);i=Math.floor(i/16);return[a,i]};return b}();v=function(){function b(a){this.type=a;this.seen=!1}b.draw={".":function(a){a.fillStyle="rgba(128,128,128,0.75)";a.fillRect(0,0,16,16)}," ":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16)},"#":function(a){a.fillStyle="brown";a.fillRect(0,0,16,16)},">":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16);a.strokeStyle="brown";a.beginPath();a.moveTo(7.5,2);a.lineTo(7.5,14);a.lineTo(3.5,10);a.lineTo(11.5,10);a.lineTo(7.5,14);
a.stroke()},"<":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16);a.strokeStyle="brown";a.beginPath();a.moveTo(7.5,14);a.lineTo(7.5,2);a.lineTo(3.5,6);a.lineTo(11.5,6);a.lineTo(7.5,2);a.stroke()},"%":function(a){a.fillStyle="#8f8";a.fillRect(0,0,16,16)},"*":function(a){a.fillStyle="#ff0";a.fillRect(0,0,16,16)}};b.prototype.draw=function(a,i){if(i)this.seen=!0;if(this.seen&&(b.draw[this.type](a.ctx),!i))b.draw["."](a.ctx)};b.prototype.isOpen=function(){return this.type!=="#"};b.prototype.isSeen=
function(){return this.seen};b.prototype.getType=function(){return this.type};b.prototype.takeItem=function(){this.type=" "};return b}();w=function(){function b(a){this.tiles=a.split("\n").map(function(a){return a.split("").map(function(a){return new v(a)})});this.npc=[]}function a(a,b,c,d,g){function e(m,f,c){for(var m={x:m,y:f,prev:c,g:c?c.g+1:0,h:Math.max(Math.abs(m-a),Math.abs(f-b))},d,c=m.g+m.h,f=0;f<o.length;f++)if(d=o[f].g+o[f].h,c<d||c===d&&m.h<o[f].h){o.splice(f,0,m);return}o.push(m)}var o=
[],h={},n,l;for(e(c,d);o.length;)if(c=o.shift(),d=c.x+","+c.y,!h[d]){h[d]=c;if(c.x===a&&c.y===b)break;n=g(c.x,c.y);for(l=0;l<n.length;l++)d=n[l][0]+","+n[l][1],h[d]||e(n[l][0],n[l][1],c)}if(c=h[a+","+b]){for(g=[];c;)g.push([c.x,c.y]),c=c.prev;return g}}b.prototype.draw=function(a,b){var c=this.tiles.length,d=this.tiles[0].length,g,p,o=!1;a.setSize(d,c);a.ctx.fillStyle="#000";a.ctx.fillRect(0,0,d*16,c*16);for(g=0;g<d;g++)for(p=0;p<c;p++)a.ctx.save(),a.ctx.translate(g*16,p*16),this.tiles[p][g].draw(a,
b.canSee(g,p)),a.ctx.restore();this.visibleMonsters=[];for(c=0;c<this.npc.length;c++)d=this.npc[c],g=d.x,p=d.y,b.canSee(g,p)?(a.ctx.save(),a.ctx.translate(g*16,p*16),d.draw(a),a.ctx.restore(),d.seen||e(d.seenBefore?"you see "+d.getDesc(!0)+" again.":"you see "+d.getDesc()+"."),d.seen=!0,o=d.seenBefore=!0,this.visibleMonsters.push(d)):d.seen=!1;a.ctx.save();a.ctx.translate(b.x*16,b.y*16);b.draw(a);a.ctx.restore();b.showLuck();return o};b.prototype.isOpen=function(a,b){return a<0||a>=this.tiles[0].length||
b<0||b>=this.tiles.length?!1:this.tiles[b][a].isOpen()};b.prototype.hasBeenSeen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isSeen()};b.prototype.getType=function(a,b){return this.tiles[b][a].getType()};b.prototype.takeItem=function(a,b){return this.tiles[b][a].takeItem()};b.prototype.monsterAt=function(a,b){var c,d;for(c=0;c<this.npc.length;c++)if(d=this.npc[c],d.x===a&&d.y===b)return d};b.prototype.findFreeTile=function(a){var b,c,d;for(b=0;b<
1E4;b++)if(c=Math.floor(Math.random()*this.tiles[0].length),d=Math.floor(Math.random()*this.tiles.length),this.isOpen(c,d)&&!this.monsterAt(c,d)&&!a.canSee(c,d))return[c,d]};b.prototype.spawnMonster=function(a,b){var c;if(b||!(Math.random()>0.05))(c=this.findFreeTile(a))&&this.npc.push(new y("x",c[0],c[1],this))};b.prototype.removeMonster=function(a){this.npc.splice(this.npc.indexOf(a),1)};b.prototype.findPath=function(b,k,c,d,g){var e=this;return a(b,k,c,d,function(a,b){return[[-1,0],[1,0],[0,-1],
[0,1],[-1,-1],[1,-1],[-1,1],[1,1]].map(function(c){return[a+c[0],b+c[1]]}).filter(function(a){return e.isOpen(a[0],a[1])&&(!g||e.hasBeenSeen(a[0],a[1]))})})};b.prototype.autoexplore=function(a){var b=Infinity,c,d,g,e,o;for(e=0;e<this.tiles[0].length;e++)for(o=0;o<this.tiles.length;o++)this.isOpen(e,o)&&!this.hasBeenSeen(e,o)&&(g=Math.max(Math.abs(a.x-e),Math.abs(a.y-o)),g<b&&(c=e,d=o,b=g));if(b!==Infinity&&(a=this.findPath(a.x,a.y,c,d))){for(b=0;b<a.length;b++)if(!this.hasBeenSeen(a[b][0],a[b][1])){a.length=
b+1;break}return a}};return b}();x=function(){function b(){this.levels=[this.createLevel(3,3,0)];this.currentLevel=0}b.prototype.init=function(a){a.x=3;a.y=3;a.level=this.levels[0];this.levels[0].spawnMonster(a,!0)};b.prototype.createLevel=function(a,b,e){function c(a){var b,c;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*d.length),d.charAt(c)===".")return d=d.slice(0,c)+a+d.slice(c+1),!0}var d=t(a,b);c("%");c("%");c("%");c("*");d=d.replace(/\./g," ");e===0?d=d.replace("<"," "):e===2&&(d=d.replace(">",
" "));return new w(d)};b.prototype.goUp=function(a){e("you climb up the ladder.");this.currentLevel--;a.level=this.levels[this.currentLevel]};b.prototype.goDown=function(a){var b;e("you climb down the ladder.");this.currentLevel++;this.levels[this.currentLevel]||(b=this.createLevel(a.x,a.y,this.currentLevel),this.levels.push(b));a.level=this.levels[this.currentLevel];b&&b.spawnMonster(a,!0)};return b}();s=function(){function b(){}b.draw={"@":function(a){a.fillStyle="blue";a.fillRect(4,4,8,8)},x:function(a){a.fillStyle=
"green";a.fillRect(4,4,8,8)}};b.prototype.drawHealth=function(a,b,e){var c=this.health/this.maxHealth,d;d="hsl("+Math.round(140*c*c)+",100%,30%)";a.fillStyle=d;a.fillRect(0,0,b,e);a.fillStyle="#000";c=Math.round((b-2)*(1-c));a.fillRect(b-c-1,1,c,e-2);return d};b.prototype.draw=function(a){b.draw[this.type](a.ctx);this.type!=="@"&&this.health<this.maxHealth&&(a.ctx.translate(2,2),this.drawHealth(a.ctx,12,4))};b.prototype.moveTo=function(a,b){var k;this.x=a;this.y=b;if(this.type==="@")if(k=this.level.getType(a,
b),k==="%"){k="you found a four-leave clover, ";if(this.health===this.maxHealth)k+="but you leave it here for later.";else{this.level.takeItem(a,b);this.health+=7;if(this.health>this.maxHealth)this.health=this.maxHealth;k+="which"+(this.health===this.maxHealth?"":" partially")+" restores your luck."}e(k)}else k==="*"&&(this.luckyCharms++,this.level.takeItem(a,b),e("you found a lucky charm."))};b.prototype.moveRel=function(a,b){var e=this.x+a,c=this.y+b,d;if(d=this.level.monsterAt(e,c))return this.attack(d),
!0;return this.level.isOpen(e,c)?(this.moveTo(e,c),!0):!1};b.prototype.rangedFails=function(a){return Math.random()<(Math.pow(1.5,a/2)-1)/this.experience};b.prototype.blockAttack=function(){return Math.random()<this.block*this.experience};b.prototype.getAttackDamage=function(){return Math.round((this.minAttack+Math.random()*(this.maxAttack-this.minAttack))*this.experience)};b.prototype.improveExperience=function(a){a=this.experience*Math.pow(2,a/500);Math.floor(a*10)!==Math.floor(this.experience*
10)&&e("you feel more experienced now.");this.experience=a};b.prototype.attack=function(a,b){function k(a,b){var e=a.x-b.x,i=a.y-b.y;return Math.sqrt(e*e+i*i)}if(a.health!==0)if(b&&this.rangedFails(k(a,this)))this.type==="@"?e("you try to hit "+a.getDesc(!0)+", but miss."):e(this.getDesc(!0)+" tries to hit you, but misses.");else if(a.blockAttack())this.type==="@"?e("you try to hit "+a.getDesc(!0)+", but your attack is blocked."):e(this.getDesc(!0)+" tries to hit you, but you block the attack.");
else if(this.type==="@"?e("you hit "+a.getDesc(!0)+"."):e(this.getDesc(!0)+" hits you."),a.health-=this.getAttackDamage(),a.health<=0)a.health=0,a.die(),this.type==="@"&&this.improveExperience(a.maxHealth)};b.prototype.die=function(){this.type==="@"?e("you are out of luck and lose the game."):(e(this.getDesc(!0)+" vanishes."),this.level.removeMonster(this))};return b}();y=function(){function b(a,b,e,c){this.type=a;this.x=b;this.y=e;this.level=c;this.seenBefore=this.seen=!1;this.maxHealth=this.health=
10;this.experience=1;this.block=0.1;this.minAttack=1;this.maxAttack=2}b.prototype=new s;b.desc={x:["a green monster","the green monster"]};b.prototype.getDesc=function(a){return b.desc[this.type][a?1:0]};b.prototype.walkRandom=function(){var a,b;do a=Math.floor(Math.random()*3)-1,b=Math.floor(Math.random()*3)-1;while(!this.level.isOpen(this.x+a,this.y+b));this.level.monsterAt(this.x+a,this.y+b)||this.moveRel(a,b)};b.prototype.huntPlayer=function(a){a=this.level.findPath(this.x,this.y,a.x,a.y);!a||
a.length<2||this.level.monsterAt(a[1][0],a[1][1])?this.walkRandom():this.moveRel(a[1][0]-a[0][0],a[1][1]-a[0][1])};b.prototype.monsterAI=function(a){this.seenBefore&&(Math.abs(a.x-this.x)<=1&&Math.abs(a.y-this.y)<=1?this.attack(a):this.seen?this.huntPlayer(a):this.walkRandom())};return b}();z=function(){function b(a){this.type="@";this.dungeon=a;a.init(this);this.sightRadius=3;this.maxHealth=this.health=77;this.experience=1;this.block=0.1;this.minAttack=1;this.maxAttack=3;this.luckyCharms=0}b.prototype=
new s;b.prototype.showLuck=function(){if(!this.luckOutput)this.luckOutput=document.getElementById("luck"),this.luckCanvas=document.getElementById("luck-canvas").getContext("2d",{alpha:!1}),this.luckCanvas.canvas.width=100,this.luckCanvas.canvas.height=10;this.luckOutput.style.color=this.drawHealth(this.luckCanvas,100,10);this.luckOutput.textContent=this.health+"/"+this.maxHealth};b.prototype.canSee=function(a,b){var e=a-this.x,c=b-this.y,d,g,p;this.level.isOpen(a,b)||(e>0?e-=0.5:e<0&&(e+=0.5),c>0?
c-=0.5:c<0&&(c+=0.5));if(e*e+c*c>this.sightRadius*this.sightRadius)return!1;for(d=0;d<this.sightRadius;d++){g=Math.round(this.x+d*e/this.sightRadius);p=Math.round(this.y+d*c/this.sightRadius);if(g===a&&p===b)break;if(!this.level.isOpen(g,p))return!1}return!0};b.prototype.goUp=function(){if(this.level.getType(this.x,this.y)==="<")return this.dungeon.goUp(this),!0};b.prototype.goDown=function(){if(this.level.getType(this.x,this.y)===">")return this.dungeon.goDown(this),!0};return b}();A=function(){function b(a,
b,c){var d;if(c){c=h.x+a;for(d=h.y+b;h.level.isOpen(c,d);)g.push(["move",a,b]),c+=a,d+=b}else g.push(["move",a,b])}function a(a){var b,c,d;for(b=0;b<a.length;b++)b>0&&g.push(["move",a[b][0]-c,a[b][1]-d]),c=a[b][0],d=a[b][1]}function i(a){var b;for(b=0;b<(a?10:1);b++)g.push(["wait"]);a&&g.push(["autowait"])}function k(a){if(!a.ctrlKey&&!a.altKey){g=[];var c;if(a.key&&a.key!=="Unidentified")c={Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown"}[a.key]||a.key;else if(!(c={12:"Clear",33:"PageUp",
34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown"}[a.which])){c=a.shiftKey;var e=String.fromCharCode(a.which).toLowerCase();c&&(e={"<":">"}[e]||e.toUpperCase());c=e}switch(c){case "1":case "End":b(-1,1,a.shiftKey);break;case "2":case "ArrowDown":b(0,1,a.shiftKey);break;case "3":case "PageDown":b(1,1,a.shiftKey);break;case "4":case "ArrowLeft":b(-1,0,a.shiftKey);break;case "5":case "Clear":case "w":case "W":i(a.shiftKey);break;case "6":case "ArrowRight":b(1,
0,a.shiftKey);break;case "7":case "Home":b(-1,-1,a.shiftKey);break;case "8":case "ArrowUp":b(0,-1,a.shiftKey);break;case "9":case "PageUp":b(1,-1,a.shiftKey);break;case "<":g.push(["goUp"]);break;case ">":g.push(["goDown"]);break;case "f":g.push(["attack"]);break;case "x":g.push(["autoexplore"])}a.preventDefault();d()}}function c(b){var c,i,j;n||(c=l.getTile(b.clientX,b.clientY),b=c[0],c=c[1],g=[],h.level.hasBeenSeen(b,c)?h.level.isOpen(b,c)?h.canSee(b,c)&&h.level.monsterAt(b,c)?Math.abs(b-h.x)<=
1&&Math.abs(c-h.y)<=1?g.push(["move",b-h.x,c-h.y]):g.push(["attack",b,c]):h.x===b&&h.y===c?(i=h.level.getType(b,c),i!=="<"&&i!==">"&&g.push(["wait"])):(i=h.level.getType(b,c),j=h.level.findPath(h.x,h.y,b,c,!0)):e("you cannot go there."):e("you don\u2019t know how to go there."),j&&a(j),i===">"?g.push(["goDown"]):i==="<"&&g.push(["goUp"]),d())}function d(){var b,c=!1,k,j;for(clearTimeout(p);!c;){if(g.length===0)return;b=g.shift();if(n)return;switch(b[0]){case "move":c=h.moveRel(b[1],b[2]);break;case "goUp":c=
h.goUp();break;case "goDown":c=h.goDown();break;case "attack":if(b[1])for(k=0;k<h.level.visibleMonsters.length;k++)if(j=h.level.visibleMonsters[k],j.x===b[1]&&j.y===b[2])break;else j=null;else j=h.level.visibleMonsters[0];j&&(h.attack(j,!0),c=!0);break;case "wait":c=!0;break;case "autowait":e("still waiting, press c to cancel.");i(!0);break;case "autoexplore":(b=h.level.autoexplore(h))?(a(b),g.push(["autoexplore"])):e("level completely explored.")}}e.async(!0);h.level.spawnMonster(h);for(k=0;k<h.level.npc.length;k++)if(j=
h.level.npc[k],j.speed)for(j.movesLeft=(j.movesLeft||0)+1;j.movesLeft>=j.speed;)j.monsterAI(h),j.movesLeft-=j.speed;else j.monsterAI(h);e.async(!1);c=h.level.draw(l,h);e.clearQueue();c&&(g=[]);h.health===0&&(g=[],n=!0);h.luckyCharms===3&&(e("you found all lucky charms and win the game."),n=!0);g.length>0&&(p=setTimeout(d,o))}var g=[],p,o=200,h,n=!1,l=new u("canvas");return{init:function(a){h=a;document.addEventListener("keydown",k);l.canvas.addEventListener("click",c);h.level.draw(l,h)}}}();(function(){var b=
new x,b=new z(b);A.init(b)})()})();
</script>
</body></html>