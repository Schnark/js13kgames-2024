<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<title>Lord Balsekilâ€™s Lairs of Bad Luck</title>
<meta name="viewport" content="width=device-width">
<style>
html{font-family:sans-serif}#log{overflow-y:scroll;height:4.5em;line-height:1.5em;padding:0}#log li{display:block}.b{font-weight:bold}#wrap{position:relative}#cover{position:absolute;top:0;left:0;pointer-events:none}#canvas,#inv canvas{image-rendering:-moz-crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;image-rendering:pixelated}#canvas,.mushroom{cursor:pointer}#inv canvas{width:32px;height:32px;margin-left:0.5em}#luck-container,#inv{display:inline-block}</style>
</head><body>
<ol id="log" reversed></ol>
<div id="wrap">
<canvas id="canvas" moz-opaque></canvas>
<canvas id="cover"></canvas>
</div>
<p id="luck-container">Luck: <span id="luck"></span><br>
<canvas id="luck-canvas" moz-opaque></canvas></p>
<p id="inv"></p>
<section>
<h2>Help</h2>
<p>Use number pad to move (or arrow keys but without diagonal movement), hold shift to walk to next wall. Or click on a place to go to (if you have seen it before).</p>
<p>To climb up and down ladders use &lt; and &gt;. Or just click on it.</p>
<p>Press x to automatically explore the map.</p>
<p>Press w to wait a turn, or W to wait until you see an enemy.</p>
<p>To attack an enemy, press f for a ranged attack, or walk into it for a melee attack. Or just click on it.</p>
<p>Press e to eat a mushroom, or click it in your inventory.</p>
</section>
<script>
(function(){var h,v,t,w,x,y,u,s,z,A;h=function(){function c(c,d){var i;k?a.push([c,d]):(i=document.createElement("li"),i.textContent=c.charAt(0).toUpperCase()+c.slice(1),i.className=d||"",b.insertBefore(i,b.firstChild),b.scrollTop=0)}var b=document.getElementById("log"),a=[],k=!1;c.async=function(a){k=a};c.clearQueue=function(){a.forEach(function(a){c(a[0],a[1])});a=[]};return c}();v=function(){function c(a,b){a=Math.ceil(a);b=Math.floor(b);return Math.floor(a+Math.random()*(b+1-a))}function b(a,
b,d,i){function e(a,b){var k,c;for(k=0;k<a.w;k++)for(c=0;c<a.h;c++)p[c+a.y+1][k+a.x+1]=b}var l,j,r,p=[];for(j=0;j<g+2;j++){r=[];for(l=0;l<k+2;l++)r.push("#");p.push(r)}for(j=0;j<b.length;j++)e(b[j]," ");for(j=0;j<a.length;j++)e(a[j],".");p[i+1][d+1]="<";j=a.length===1?0:c(1,a.length-1);l=c(0,a[j].w-1)+a[j].x;j=c(0,a[j].h-1)+a[j].y;p[j+1][l+1]=">";return p.map(function(a){return a.join("")}).join("\n")}function a(a,b,k){var g,d,l;Math.random()<0.5?(g=a,a=b):g=b;for(b=0;b<i;b++){d=2*c(g.x/2,(g.x+g.w-
1)/2);l=2*c(a.y/2,(a.y+a.h-1)/2);var j;a:{j=k;for(var r=d,p=l,o=void 0,o=0;o<j.length;o++)if((r===j[o].x-1||r===j[o].x+j[o].w)&&j[o].y-1<=p&&p<=j[o].y+j[o].h||(p===j[o].y-1||p===j[o].y+j[o].h)&&j[o].x-1<=r&&r<=j[o].x+j[o].w){j=!0;break a}j=!1}if(!j)break}k={x:d,y:Math.min(g.y,l),w:1,h:Math.abs(g.y-l)+1};d={x:Math.min(a.x,d),y:l,w:Math.abs(a.x-d)+1,h:1};return[k,d]}var k=50,g=20,d=0.3*k*g,i=1E4;return function(f,i){f===-1?(f=c(0,k-1),i=c(0,g-1)):(f--,i--);var h=[],m,e,l;a:{m=f;l=i;var j;for(e=0;e<
1E4;e++)if(j={x:c(0,m),y:c(0,l),w:c(4,12),h:c(4,8)},j.x+j.w<=k&&j.y+j.h<=g&&j.x+j.w>m&&j.y+j.h>l){e=j;break a}e={x:m,y:l,w:1,h:1}}l=e.w*e.h;h.push(e);for(m=0;m<1E4;m++){a:{e=h;var r=j=void 0;j={x:c(0,k-4),y:c(0,g-4),w:c(4,12),h:c(4,8)};if(!(j.x+j.w>k)&&!(j.y+j.h>g)){for(r=0;r<e.length;r++){var p;p=e[r];var o=j;p=Math.abs(p.x-o.x)>(p.x<o.x?p.w:o.w)?!1:Math.abs(p.y-o.y)>(p.y<o.y?p.h:o.h)?!1:!0;if(p){e=void 0;break a}}e=j}else e=void 0}if(e&&(l+=e.w*e.h,h.push(e),l>=d))break}l=[];for(m=1;m<h.length;m++)l=
l.concat(a(h[c(0,m-1)],h[m],h));return b(h,l,f,i)}}();t=function(){function c(){this.canvas=document.getElementById("canvas");this.ctx=this.canvas.getContext("2d",{alpha:!1});this.cover=document.getElementById("cover");this.coverCtx=this.cover.getContext("2d")}c.animations=[];c.addAnimation=function(b,a,k,g,d){c.animations.push({x0:b,y0:a,x1:k,y1:g,h:d})};c.prototype.loadSprites=function(b){var a=new Image;this.sprites=[];a.onload=function(){var k,c,d;for(k=0;k<18;k++)c=document.createElement("canvas"),
c.width=16,c.height=16,d=c.getContext("2d"),d.drawImage(a,k*16,0,16,16,0,0,16,16),this.sprites.push(c);this.prepareInv();b()}.bind(this);a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASAAAAAQCAMAAACBUFKrAAAAAXNSR0IArs4c6QAAADZQTFRFAAAAAAAAAHcAAKoAQh8fREREXywRZgBmiAAAiACIiEQAiIiIqgCqu2YAzAAAzMzM3d0A////qlkdZwAAAAF0Uk5TAEDm2GYAAAN5SURBVFjDpZiLYqsgDIbBjjPEyur7v+xJSCAXdHNdrBeU2vL1/0Ns+HLxAdE2tP36KQJFzsHEghGuomCEb8JfjhDhdpx09md8239/iXcB/eOV71+PbPE8Hg9N6Lnq0e8YloFBNgG8AUh6xLm3P+Pbudb8R0AdyGhjMKAM94dPkI9APEhI+DzXVfFBQrAWzef1ehVN0BC6o6DeJc6AYo3wsrfTXej73wPk46AYQEZbFJSPo9bxEWgtD+iJgJhQIfXQTgDtilDZF1jK9YCuAEXa1zPBqDORgEXhEyu88k0Faf18fACMqoH4drMXAGprRj4PMljz2NL5IKBV+OgDBYgJsQW1AW1z27YrQrGHutB+ELiF5aUBVSeh+gaglBIBqkhDLMZ3JxVlEg+noIXS0LMDWonE3jEUDUhJqHgDBu/HUs4Q0ZhnQnvBkZX9tsWQT62/ApQakASACIcoiAH1H2Fh7RAkdNlTAK1mqOYQG0U8psUFS9AZaSeBEaE4NiMLTYQKDa1oi1VnsagtVhueqgFt21UOIiCpKSilyWJgsIEHLmVxF6ehpwa0ngPipC2J2UxpsOjx7gyJCOF5PX/xPql3xA5IONaoklDGBGSTEI7GWmwAMvKBDVtqBsQWy91fBwNanIKYzCcFakVNVibnCBVTRZUyS6IMDZkrIqHUEJ0CirEriDrkBidG7bIZkJnmLSBnsUlBIwGxx5aeg7gU0oC0bsyByTG2ihp8eMA74YGDBugFi6t/4lfSGrKAYhQFYYdcRUFMqLYMVG8DOmySdtN8NsE/P7uMBimAer5x+zM+QqhERsSppkTi46YkhbABEkIekOSgBihLDuqlXJNPvVcHNQ7b3NaFIsy7x7FdjjB0QCb1dCjTnN6LhP5+pyBK0WoSm/g0iyWitM1JetQCnLuABs9iVc3uoX4/zY8NAnEJvLXto4YBtEiGFkKKT2FAbT/x2ffBl3QCPWhAO6fnvpkB6VMpjVNvAQq/AHTyGGYBbei6bfDhhzH1LIaAgp3C/V4AUY6GdzMg0dBVeRh9h86LRfdjHdTTw3uAzn2nLaYA9enHPc2vn7rMs/vdP9jDFIgr26jgNBa2W4CkB+hj6xWSr6S5NhCbIpycT8vzOznoxtP8Nor/b/7kuIrpjw8slHEddRAO5hxPEKu0AyMhoQWH+v2+DXDaehL/AUuEYEGHlncmAAAAAElFTkSuQmCC"};
c.prototype.prepareInv=function(){var b=document.getElementById("inv"),a;a=this.sprites[7];a.style.display="none";a.title="horseshoe";b.appendChild(a);a=this.sprites[8];a.style.display="none";a.title="flashlight";b.appendChild(a);a=this.sprites[6];a.style.display="none";a.title="lucky charm";b.appendChild(a);b.appendChild(document.createElement("span"));a=this.sprites[4];a.style.display="none";a.title="lucky mushroom";a.className="mushroom";b.appendChild(a);a=document.createElement("span");a.className=
"mushroom";b.appendChild(a)};c.prototype.setSize=function(b,a){var k=b*16,c=a*16,d,i,f;d=Math.min((window.innerWidth-30)/k,(window.innerHeight-80)/c);i=k*d+"px";f=c*d+"px";if(this.canvas.width!==k)this.canvas.width=k,this.canvas.height=c,this.cover.width=k,this.cover.height=c;if(this.f!==d)this.f=d,this.canvas.style.width=i,this.canvas.style.height=f,this.cover.style.width=i,this.cover.style.height=f};c.prototype.getTile=function(b,a){var k=this.canvas.getBoundingClientRect(),b=(b-k.left)/this.f,
a=(a-k.top)/this.f,b=Math.floor(b/16),a=Math.floor(a/16);return[b,a]};c.prototype.showTarget=function(b,a,k){b=b*16+8;a=a*16+8;this.coverCtx.fillStyle="rgba(255,255,255,0.75)";this.coverCtx.fillRect(b,a,8,8);this.coverCtx.font="10px monospace";this.coverCtx.textAlign="center";this.coverCtx.fillStyle="#000";this.coverCtx.fillText(k,b+4,a+8)};c.prototype.clearTargets=function(){this.coverCtx.clearRect(0,0,this.cover.width,this.cover.height)};c.prototype.showAnimation=function(b,a,k,c,d,i){var f;f=i*
Math.PI*4;d&&(i=i>0.5?2-2*i:2*i);b+=(k-b)*i;a+=(c-a)*i;this.coverCtx.save();this.coverCtx.translate(b*16+8,a*16+8);this.coverCtx.rotate(f);this.coverCtx.drawImage(this.sprites[d?7:17],-8,-8);this.coverCtx.restore()};c.prototype.runAnimations=function(){var b=window.requestAnimationFrame||window.mozRequestAnimationFrame,a,k;c.animations.length!==0&&(k=function(g){var d,i;a||(a=g);this.clearTargets();d=(g-a)/200;if(d<=1){for(g=0;g<c.animations.length;g++)i=c.animations[g],this.showAnimation(i.x0,i.y0,
i.x1,i.y1,i.h,d);b(k)}else c.animations=[]}.bind(this),b(k))};return c}();w=function(){function c(b){this.type=b;this.seen=!1}c.draw={".":function(b){b.fillStyle="rgba(128,128,128,0.75)";b.fillRect(0,0,16,16)}," ":function(b,a){b.drawImage(a[0],0,0)},"#":function(b,a){b.drawImage(a[1],0,0)},">":function(b,a){b.drawImage(a[2],0,0)},"<":function(b,a){b.drawImage(a[3],0,0)},F:function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[4],0,0)},"%":function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[5],0,0)},"*":function(b,
a){b.drawImage(a[0],0,0);b.drawImage(a[6],0,0)},")":function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[7],0,0)},"(":function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[8],0,0)}};c.prototype.draw=function(b,a){if(a)this.seen=!0;if(this.seen&&(c.draw[this.type](b.ctx,b.sprites),!a))c.draw["."](b.ctx)};c.prototype.isOpen=function(){return this.type!=="#"};c.prototype.isSeen=function(){return this.seen};c.prototype.getType=function(){return this.type};c.prototype.takeItem=function(b){this.type=b||" "};return c}();
x=function(){function c(a,b){this.tiles=a.split("\n").map(function(a){return a.split("").map(function(a){return new w(a)})});this.npc=[];this.depth=b}function b(a,b,c,d,i){function f(c,d,g){for(var c={x:c,y:d,prev:g,g:g?g.g+1:0,h:Math.max(Math.abs(c-a),Math.abs(d-b))},f,g=c.g+c.h,d=0;d<h.length;d++)if(f=h[d].g+h[d].h,g<f||g===f&&c.h<h[d].h){h.splice(d,0,c);return}h.push(c)}var h=[],q={},m,e;for(f(c,d);h.length;)if(c=h.shift(),d=c.x+","+c.y,!q[d]){q[d]=c;if(c.x===a&&c.y===b)break;m=i(c.x,c.y);for(e=
0;e<m.length;e++)d=m[e][0]+","+m[e][1],q[d]||f(m[e][0],m[e][1],c)}if(c=q[a+","+b]){for(i=[];c;)i.push([c.x,c.y]),c=c.prev;return i}}c.prototype.draw=function(a,b){var c=this.tiles.length,d=this.tiles[0].length,i,f,B=!1;a.setSize(d,c);a.ctx.fillStyle="#000";a.ctx.fillRect(0,0,d*16,c*16);for(i=0;i<d;i++)for(f=0;f<c;f++)a.ctx.save(),a.ctx.translate(i*16,f*16),this.tiles[f][i].draw(a,b.canSee(i,f)),a.ctx.restore();this.visibleMonsters=[];for(c=0;c<this.npc.length;c++)d=this.npc[c],i=d.x,f=d.y,b.canSee(i,
f)?(a.ctx.save(),a.ctx.translate(i*16,f*16),d.draw(a),a.ctx.restore(),d.seen||h(d.seenBefore?"you see "+d.getDesc(!0)+" again.":"you see "+d.getDesc()+"."),d.seen=!0,B=d.seenBefore=!0,this.visibleMonsters.push(d)):d.seen=!1;a.ctx.save();a.ctx.translate(b.x*16,b.y*16);b.draw(a);a.ctx.restore();b.showLuck();return B};c.prototype.isOpen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isOpen()};c.prototype.hasBeenSeen=function(a,b){return a<0||a>=this.tiles[0].length||
b<0||b>=this.tiles.length?!1:this.tiles[b][a].isSeen()};c.prototype.getType=function(a,b){return this.tiles[b][a].getType()};c.prototype.takeItem=function(a,b,c){return this.tiles[b][a].takeItem(c)};c.prototype.monsterAt=function(a,b){var c,d;for(c=0;c<this.npc.length;c++)if(d=this.npc[c],d.x===a&&d.y===b)return d};c.prototype.findFirst=function(a){var b,c;for(b=0;b<this.tiles[0].length;b++)for(c=0;c<this.tiles.length;c++)if(this.tiles[c][b].getType()===a)return[b,c]};c.prototype.findFreeTile=function(a){var b,
c,d;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*this.tiles[0].length),d=Math.floor(Math.random()*this.tiles.length),this.isOpen(c,d)&&!this.monsterAt(c,d)&&!a.canSee(c,d))return[c,d]};c.prototype.findFreeTileNear=function(a,b,c){for(var d=0,i,f;;){for(i=a-d;i<=a+d;i++)for(f=b-d;f<=b+d;f++)if(this.isOpen(i,f)&&!this.monsterAt(i,f)&&!c.canSee(i,f))return[i,f];d++}};c.prototype.addMonster=function(a,b,c){a.place(b,c,this);this.npc.push(a)};c.prototype.removeMonster=function(a){this.npc.splice(this.npc.indexOf(a),
1)};c.prototype.leave=function(){var a;for(a=0;a<this.npc.length;a++)this.npc[a].seen=!1};c.prototype.findPath=function(a,c,g,d,i){var f=this;return b(a,c,g,d,function(a,b){return[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]].map(function(c){return[a+c[0],b+c[1]]}).filter(function(a){return f.isOpen(a[0],a[1])&&(!i||f.hasBeenSeen(a[0],a[1]))})})};c.prototype.autoexplore=function(a){var b=Infinity,c,d,i,f,h;for(f=0;f<this.tiles[0].length;f++)for(h=0;h<this.tiles.length;h++)this.isOpen(f,h)&&
!this.hasBeenSeen(f,h)&&(i=Math.max(Math.abs(a.x-f),Math.abs(a.y-h)),i<b&&(c=f,d=h,b=i));if(b!==Infinity&&(a=this.findPath(a.x,a.y,c,d))){for(b=0;b<a.length;b++)if(!this.hasBeenSeen(a[b][0],a[b][1])){a.length=b+1;break}return a}};return c}();y=function(){function c(){function b(a){var b=Object.keys(a),c,k=0;for(c=0;c<b.length;c++)k+=a[b[c]];for(c=0;c<b.length;c++)a[b[c]]/=k;return a}var a,c,g;this.levelData=[{items:[],monsters:[]},{items:[],monsters:[]},{items:[],monsters:[]}];this.levelData[Math.floor(Math.random()*
2)].items.push("(");this.levelData[Math.floor(Math.random()*2)].items.push(")");this.levelData[Math.floor(Math.random()*2)].items.push("*");this.levelData[Math.floor(Math.random()*2)].items.push("*");for(a=0;a<this.levelData.length;a++){g=2+Math.floor(Math.random()*2);for(c=0;c<g;c++)this.levelData[a].items.push("%");g=1+Math.floor(Math.random()*2);for(c=0;c<g;c++)this.levelData[a].items.push("F")}for(a=0;a<this.levelData.length;a++)this.levelData[a].monsters.push(":1"),this.levelData[a].monsters.push((a+
1)*Math.random()<1?":1":":2"),a===1&&this.levelData[a].monsters.push(Math.random()<0.5?"&1":"n"),a>=1&&this.levelData[a].monsters.push(Math.random()<0.5?"f1":"B1"),this.levelData[a].monsterProbs=b({":1":3,":2":2,":3":1,f1:a-1,f2:(a-1)/2,f3:(a-1)/4,B1:a-1,B2:(a-1)/2,B3:(a-1)/4,n:2,"&1":1});this.levels=[this.createLevel(3,3,0)];this.currentLevel=0;this.henchmen=[];this.maxHenchmen=1}c.prototype.init=function(b){b.place(3,3,this.levels[0]);b.missedEarlyLuckyCharms=2;this.initMonsters(b)};c.prototype.createLevel=
function(b,a,c){function g(a){var b,c;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*d.length),d.charAt(c)==="."){d=d.slice(0,c)+a+d.slice(c+1);return}d=d.replace(/./,a)}for(var d=v(b,a),b=0;b<this.levelData[c].items.length;b++)g(this.levelData[c].items[b]);d=d.replace(/\./g," ");c===0?d=d.replace("<"," "):c===this.levelData.length-1&&(d=d.replace(">"," "));return new x(d,c)};c.prototype.goUp=function(b){h("you climb up the ladder.");this.levels[this.currentLevel].leave();this.currentLevel--;b.level=
this.levels[this.currentLevel]};c.prototype.goDown=function(b){var a;h("you climb down the ladder.");this.levels[this.currentLevel].leave();this.currentLevel++;this.levels[this.currentLevel]||(a=this.createLevel(b.x,b.y,this.currentLevel),this.levels.push(a));b.level=this.levels[this.currentLevel];a&&this.initMonsters(b)};c.prototype.createHenchman=function(){var b;if(this.henchmen.length===this.maxHenchmen)return new s("n");b=new s("&1");this.henchmen.push(b);b.desc[1]+=this.henchmen.length;return b};
c.prototype.createMonster=function(b){return b==="&1"?this.createHenchman():new s(b)};c.prototype.createRandomMonster=function(b){for(var a=Object.keys(b),c=Math.random();a.length>1&&b[a[0]]<c;)c-=b[a[0]],a.shift();return this.createMonster(a[0])};c.prototype.initMonsters=function(b){var a,c=this.levels[this.currentLevel],g,d;this.currentLevel===2&&(a=c.findFirst("<"),c.isOpen(a[0]-1,a[1])?a[0]--:a[0]++,c.addMonster(new s("@2"),a[0],a[1]));if(this.currentLevel===this.levelData.length-1)a=c.findFreeTile(b),
c.addMonster(new s("&2"),a[0],a[1]),this.transferHenchmen(a[0],a[1],b,c),this.maxHenchmen=2,a=c.findFreeTileNear(a[0],a[1],b),c.addMonster(this.createHenchman(),a[0],a[1]);d=this.levelData[this.currentLevel].monsters;for(g=0;g<d.length;g++)(a=c.findFreeTile(b))&&c.addMonster(this.createMonster(d[g]),a[0],a[1])};c.prototype.spawnMonster=function(b){var a=this.levels[this.currentLevel];Math.random()>0.05||(b=a.findFreeTile(b))&&a.addMonster(this.createRandomMonster(this.levelData[this.currentLevel].monsterProbs),
b[0],b[1])};c.prototype.transferHenchmen=function(b,a,c,g){var d,i,f;f=!1;if(!this.henchmenTransferred){for(d=0;d<this.henchmen.length;d++)i=this.henchmen[d],i.health!==0&&(f=g.findFreeTileNear(b,a,c),i.level.removeMonster(i),g.addMonster(i,f[0],f[1]),f=!0);f&&h("you sense that all of Lord Balsekil\u2019s henchmen rushed to his help.","b");this.henchmenTransferred=!0}};return c}();u=function(){function c(){}c.draw={"@":function(b,a){b.drawImage(a[9],0,0)},"@2":function(b,a){b.drawImage(a[10],0,0)},
":1":function(b,a){b.drawImage(a[11],0,0)},":2":function(b,a){b.drawImage(a[11],0,0)},":3":function(b,a){b.drawImage(a[11],0,0)},f1:function(b,a){b.drawImage(a[12],0,0)},f2:function(b,a){b.drawImage(a[12],0,0)},f3:function(b,a){b.drawImage(a[12],0,0)},B1:function(b,a){b.drawImage(a[13],0,0)},B2:function(b,a){b.drawImage(a[13],0,0)},B3:function(b,a){b.drawImage(a[13],0,0)},n:function(b,a){b.drawImage(a[14],0,0)},"&1":function(b,a){b.drawImage(a[15],0,0)},"&2":function(b,a){b.drawImage(a[16],0,0)}};
c.prototype.init=function(b){this.health=b.health||10;this.maxHealth=b.health||10;this.experience=b.experience||1;this.block=b.block||0.1;this.minAttack=b.minAttack||1;this.maxAttack=b.maxAttack||2;if(b.speed)this.speed=1/b.speed;this.aiMode=b.aiMode;if(b.desc)this.desc=JSON.parse(JSON.stringify(b.desc));this.attackName=b.attackName};c.prototype.place=function(b,a,c){this.x=b;this.y=a;this.level=c};c.prototype.drawHealth=function(b,a,c){var g=this.health/this.maxHealth,d;d="hsl("+Math.round(140*g*
g)+",100%,30%)";b.fillStyle=d;b.fillRect(0,0,a,c);b.fillStyle="#000";g=Math.round((a-2)*(1-g));b.fillRect(a-g-1,1,g,c-2);return d};c.prototype.draw=function(b){c.draw[this.type](b.ctx,b.sprites);!this.isPlayer&&this.health<this.maxHealth&&(b.ctx.translate(2,2),this.drawHealth(b.ctx,12,4))};c.prototype.moveTo=function(b,a){var c;this.x=b;this.y=a;this.isPlayer&&(c=this.level.getType(b,a),c!==" "&&(c=this.handleItem(c))&&this.level.takeItem(b,a))};c.prototype.moveRel=function(b,a){var c=this.x+b,g=
this.y+a,d;if(d=this.level.monsterAt(c,g))return this.attack(d),!0;return this.level.isOpen(c,g)?(this.moveTo(c,g),!0):!1};c.prototype.rangedFails=function(b){return Math.random()<(Math.pow(1.3,b/2)-1)/this.experience};c.prototype.blockAttack=function(){return Math.random()<this.block*this.experience*(this.hasHorseshoe&&!this.usesHorseshoe?3:1)};c.prototype.getAttackDamage=function(){return Math.round((this.minAttack+Math.random()*(this.maxAttack-this.minAttack))*this.experience)};c.prototype.improveExperience=
function(b){this.luckyMushroomTimeout&&(this.experience/=2);b=this.experience*Math.pow(2,b/500);b>2&&(b=2);Math.floor(b*10)!==Math.floor(this.experience*10)&&h("you feel more experienced now.","b");this.experience=b;this.luckyMushroomTimeout&&(this.experience*=2)};c.prototype.getAttackName=function(b,a){var c;return this.isPlayer?(c=b?this.hasHorseshoe?"throw your horseshoe at":"yell your lucky number at":"hit",a&&(c="try to "+c),"you "+c+" "):(c=this.attackName?this.attackName[a?0:1]:a?"tries to attack":
"attacks",this.getDesc(!0)+" "+c+" ")};c.prototype.attack=function(b,a){function c(a,b){var k=a.x-b.x,f=a.y-b.y;return Math.sqrt(k*k+f*f)}b.health!==0&&(a&&t.addAnimation(this.x,this.y,b.x,b.y,this.hasHorseshoe),a&&this.rangedFails(c(b,this))?this.isPlayer?h(this.getAttackName(!0,!0)+b.getDesc(!0)+", but miss."):h(this.getAttackName(!0,!0)+"you, but misses."):a&&this.hasHorseshoe&&b.type==="n"?(h("uh-oh! The mirror-monster shatters!","b"),b.level.removeMonster(b),this.reduceHealth(20)):b.blockAttack()?
this.isPlayer?h(this.getAttackName(a,!0)+b.getDesc(!0)+", but your attack is blocked."):h(this.getAttackName(a,!0)+"you, but you block the attack."):(this.isPlayer?h(this.getAttackName(a)+b.getDesc(!0)+"."):(h(this.getAttackName(a)+"you."),this.type.charAt(0)==="B"&&Math.random()<0.2&&(h(this.getDesc(!0)+" hits your eyes."),b.makeBlind())),b.reduceHealth(this.getAttackDamage())&&this.isPlayer&&this.improveExperience(b.maxHealth)))};c.prototype.reduceHealth=function(b){this.health-=b;if(this.health<=
0)return this.health=0,this.die(),!0};c.prototype.die=function(){this.isPlayer?h("you are out of luck and lose the game.","b"):(h(this.getDesc(!0)+" vanishes.","b"),this.type==="&2"&&(this.level.takeItem(this.x,this.y,"*"),h(this.getDesc(!0)+" left back a lucky charm!","b")),this.level.removeMonster(this))};return c}();s=function(){function c(b){this.type=b;this.seenBefore=this.seen=!1;this.init(c.data[b])}c.prototype=new u;c.data={":1":{desc:["a small newt","the small newt"],attackName:["tries to touch",
"touches"],speed:0.5,maxAttack:1,health:5},":2":{desc:["a newt","the newt"],attackName:["tries to touch","touches"],speed:0.75},":3":{desc:["a large newt","the large newt"],attackName:["tries to touch","touches"]},B1:{desc:["a small crow","the small crow"],attackName:["tries to peck","pecks"],maxAttack:1,health:5},B2:{desc:["a crow","the crow"],attackName:["tries to peck","pecks"],speed:1.25,maxAttack:1,health:5},B3:{desc:["a large crow","the large crow"],attackName:["tries to peck","pecks"],speed:1.5,
health:5},f1:{desc:["a small black cat","the small black cat"],attackName:["tries to hiss at","hisses at"],maxAttack:1,aiMode:"ranged"},f2:{desc:["a black cat","the black cat"],attackName:["tries to hiss at","hisses at"],maxAttack:1,aiMode:"ranged"},f3:{desc:["a large black cat","the large black cat"],attackName:["tries to hiss at","hisses at"],aiMode:"ranged"},n:{desc:["a mirror monster","the mirror monster"],attackName:["tries to cast an evil look at","casts an evil look at"],aiMode:"ranged",block:0},
"&1":{desc:["one of Balsekil\u2019s henchmen","Henchman No. "],aiMode:"meleeRanged",block:0.15,health:15,minAttack:1,maxAttack:3},"&2":{desc:["Lord Balsekil","Lord Balsekil"],aiMode:"meleeRanged",block:0.2,health:25,minAttack:1,maxAttack:5,experience:1.5},"@2":{desc:["a chimney sweep","the chimney sweep"],aiMode:"hint",block:1}};c.prototype.getDesc=function(b){return this.desc[b?1:0]};c.prototype.walkRandom=function(b){var a,c;do a=Math.floor(Math.random()*3)-1,c=Math.floor(Math.random()*3)-1;while(!this.level.isOpen(this.x+
a,this.y+c));!this.level.monsterAt(this.x+a,this.y+c)&&!(b.x===this.x+a&&b.y===this.y+c)&&this.moveRel(a,c)};c.prototype.huntPlayer=function(b){var a=this.level.findPath(this.x,this.y,b.x,b.y);!a||a.length<2||this.level.monsterAt(a[1][0],a[1][1])?this.walkRandom(b):this.moveRel(a[1][0]-a[0][0],a[1][1]-a[0][1])};c.prototype.meleeAI=function(b){Math.abs(b.x-this.x)<=1&&Math.abs(b.y-this.y)<=1?this.attack(b):this.seen?this.huntPlayer(b):this.walkRandom(b)};c.prototype.rangedAI=function(b){this.seen?
this.attack(b,!0):Math.random()<0.5?this.walkRandom(b):this.huntPlayer(b)};c.prototype.meleeRangedAI=function(b){var a=b.x-this.x,c=b.y-this.y;Math.abs(a)<=1&&Math.abs(c)<=1?this.attack(b):a*a+c*c<=4?this.attack(b,!0):this.seen?Math.random()<0.5?this.attack(b,!0):this.huntPlayer(b):this.rangedAI(b)};c.prototype.hintAI=function(b){var a;if(this.seen)a=b.getHint(),this.lastHint!==a?(h(this.getDesc(!0)+": \u201c"+a+"\u201d","b"),this.lastHint=a):this.walkRandom(b)};c.prototype.monsterAI=function(b){if(this.seenBefore)switch(this.aiMode){case "ranged":this.rangedAI(b);
break;case "meleeRanged":this.meleeRangedAI(b);break;case "hint":this.hintAI(b);break;default:this.meleeAI(b)}};return c}();z=function(){function c(a){this.type="@";this.isPlayer=!0;this.dungeon=a;a.init(this);this.sightRadius=4;this.init({health:77,maxAttack:2});this.maxDepth=this.steps=0;this.hasHorseshoe=this.hasLamp=!1;this.luckyMushroomTimeout=this.luckyMushrooms=this.luckyCharms=0;this.blind=!1;this.blindTimeout=0}function b(a,b,c,d,i){for(var f=a,h=b,q=Math.abs(c-a),a=a<c?1:-1,m=-Math.abs(d-
b),b=b<d?1:-1,e=q+m,l;f!==c||h!==d;){if(!i(f,h))return!1;l=e*2;l>m&&(e+=m,f+=a);l<q&&(e+=q,h+=b)}return!0}c.prototype=new u;c.prototype.showLuck=function(){if(!this.luckOutput)this.luckOutput=document.getElementById("luck"),this.luckCanvas=document.getElementById("luck-canvas").getContext("2d",{alpha:!1}),this.luckCanvas.canvas.width=100,this.luckCanvas.canvas.height=10;this.luckOutput.style.color=this.drawHealth(this.luckCanvas,100,10);this.luckOutput.textContent=this.health+"/"+this.maxHealth};
c.prototype.showInv=function(){var a=document.getElementById("inv").childNodes;if(this.hasHorseshoe)a[0].style.display="";if(this.hasLamp)a[1].style.display="";if(this.luckyCharms)a[2].style.display="",a[3].textContent="\u00d7"+this.luckyCharms;this.luckyMushrooms?(a[4].style.display="",a[5].textContent="\u00d7"+this.luckyMushrooms):(a[4].style.display="none",a[5].textContent="")};c.prototype.getHint=function(){return!this.hasHorseshoe?"You should go back and get the horseshoe before proceeding further.":
!this.hasLamp?"You should go back and get the flashlight before proceeding further.":this.missedEarlyLuckyCharms===1?"You should go back and get the lucky charm before proceeding further.":this.missedEarlyLuckyCharms?"You should go back and get the "+this.missedEarlyLuckyCharms+" lucky charms before proceeding further.":"Well done so far! Now find and defeat Lord Balsekil who has the third lucky charm."};c.prototype.getResult=function(){var a=this.experience,b;this.luckyMushroomTimeout&&(a/=2);a=
Math.round(100*(a-1));b=this.luckyCharms*1E3+(this.maxDepth+1)*50+Math.round(a/2)+this.health;return"After "+this.steps+" steps you found "+(this.luckyCharms===1?"one lucky charm":(this.luckyCharms||"no")+" lucky charms")+", reached a depth of "+(this.maxDepth+1)+", and increased your experience by "+a+" %. For this you earn "+b+" points."};c.prototype.canSee=function(a,c){var h=a-this.x,d=c-this.y,i=this.level;this.level.isOpen(a,c)||(h>0?h-=0.5:h<0&&(h+=0.5),d>0?d-=0.5:d<0&&(d+=0.5));return h*h+
d*d>this.sightRadius*this.sightRadius?!1:b(this.x,this.y,a,c,function(b,d){return i.isOpen(b,d)||a===b&&c===d})};c.prototype.handleItem=function(a){var b=!1;if(a===">"&&this.level.depth===0)h("you found the ladder down to the second level.");else if(a==="<")Math.random()<0.3&&(h("you accidentally walked below the ladder."),this.reduceHealth(2));else if(a==="%"){a="you found a four-leave clover, ";if(this.health===this.maxHealth)a+="but you leave it here for later.";else{b=!0;this.health+=7;if(this.health>
this.maxHealth)this.health=this.maxHealth;a+="which"+(this.health===this.maxHealth?"":" partially")+" restores your luck."}h(a)}else if(a==="*")this.level.depth<2&&this.missedEarlyLuckyCharms--,this.luckyCharms++,b=!0,h("you found a lucky charm.","b");else if(a==="F")this.luckyMushrooms++,b=!0,h("you found a lucky mushroom"+(this.luckyMushrooms===1?", which you can eat to make you very strong for a short time":"")+".",this.luckyMushrooms===1?"b":"");else if(a==="("){this.hasLamp=b=!0;if(!this.blind)this.sightRadius=
6;h("you found a flashlight.","b")}else if(a===")")this.hasHorseshoe=b=!0,this.minAttack=2,this.maxAttack=4,h("you found a horseshoe. From now on you will use it for attacks (it will return like a boomerang), and to defend attacks (but only if you did not just throw it).","b");b&&this.showInv();return b};c.prototype.eat=function(){if(this.luckyMushrooms===0)return!1;this.luckyMushrooms--;this.showInv();this.luckyMushroomTimeout===0&&(this.experience*=2,h("you feel very strong!","b"));this.luckyMushroomTimeout+=
Math.floor(4+Math.random()*5);return!0};c.prototype.makeBlind=function(){if(this.blindTimeout===0)this.blind=!0,this.sightRadius=1.5,h("you can hardly see!");this.blindTimeout+=Math.floor(6+Math.random()*8)};c.prototype.handleTimeouts=function(){this.luckyMushroomTimeout>0&&(this.luckyMushroomTimeout--,this.luckyMushroomTimeout===0&&(this.experience/=2,h("you feel normal again.","b")));if(this.blindTimeout>0&&(this.blindTimeout--,this.blindTimeout===0))this.sightRadius=this.hasLamp?6:4,h("your eyes are better again.")};
c.prototype.goUp=function(){if(this.level.getType(this.x,this.y)==="<")return this.dungeon.goUp(this),!0};c.prototype.goDown=function(){if(this.level.getType(this.x,this.y)===">")return this.dungeon.goDown(this),this.maxDepth=Math.max(this.maxDepth,this.level.depth),!0};return c}();A=function(){function c(a,b,c){var d;if(c){c=e.x+a;for(d=e.y+b;e.level.isOpen(c,d);)f.push(["move",a,b]),c+=a,d+=b}else f.push(["move",a,b])}function b(a){var b,c,d;for(b=0;b<a.length;b++)b>0&&f.push(["move",a[b][0]-c,
a[b][1]-d]),c=a[b][0],d=a[b][1]}function a(a){var b;for(b=0;b<(a?10:1);b++)f.push(["wait"]);a&&f.push(["autowait"])}function k(b){var d;if(!b.ctrlKey&&!b.altKey){if(b.key&&b.key!=="Unidentified")d={Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown"}[b.key]||b.key;else if(!(d={12:"Clear",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown"}[b.which])){d=b.shiftKey;var e=String.fromCharCode(b.which).toLowerCase();d&&(e={"<":">"}[e]||
e.toUpperCase());d=e}f=[];q&&(q[d]&&f.push(q[d]),q=!1,j.clearTargets(),d="");switch(d){case "1":case "End":c(-1,1,b.shiftKey);break;case "2":case "ArrowDown":c(0,1,b.shiftKey);break;case "3":case "PageDown":c(1,1,b.shiftKey);break;case "4":case "ArrowLeft":c(-1,0,b.shiftKey);break;case "5":case "Clear":case "w":case "W":a(b.shiftKey);break;case "6":case "ArrowRight":c(1,0,b.shiftKey);break;case "7":case "Home":c(-1,-1,b.shiftKey);break;case "8":case "ArrowUp":c(0,-1,b.shiftKey);break;case "9":case "PageUp":c(1,
-1,b.shiftKey);break;case "<":f.push(["goUp"]);break;case ">":f.push(["goDown"]);break;case "e":f.push(["eat"]);break;case "f":f.push(["attack"]);break;case "x":f.push(["autoexplore"])}b.preventDefault();i()}}function g(a){var c,d,g;l||(c=j.getTile(a.clientX,a.clientY),a=c[0],c=c[1],f=[],e.level.hasBeenSeen(a,c)?e.level.isOpen(a,c)?e.canSee(a,c)&&e.level.monsterAt(a,c)?Math.abs(a-e.x)<=1&&Math.abs(c-e.y)<=1?f.push(["move",a-e.x,c-e.y]):f.push(["attack",a,c]):e.x===a&&e.y===c?(d=e.level.getType(a,
c),d!=="<"&&d!==">"&&f.push(["wait"])):(d=e.level.getType(a,c),g=e.level.findPath(e.x,e.y,a,c,!0)):h("you cannot go there."):h("you don\u2019t know how to go there."),g&&b(g),d===">"?f.push(["goDown"]):d==="<"&&f.push(["goUp"]),i())}function d(a){a.target.className==="mushroom"&&(f.push(["eat"]),i())}function i(){var c,d=!1,g,k,n;for(clearTimeout(s);!d;){if(f.length===0)return;c=f.shift();if(l)return;switch(c[0]){case "move":d=e.moveRel(c[1],c[2]);break;case "goUp":d=e.goUp();break;case "goDown":d=
e.goDown();break;case "eat":d=e.eat();break;case "attack":if(c[1])for(g=0;g<e.level.visibleMonsters.length;g++)if(n=e.level.visibleMonsters[g],n.x===c[1]&&n.y===c[2])break;else n=null;else if(e.level.visibleMonsters.length>1){q={};for(g=0;g<e.level.visibleMonsters.length;g++)n=e.level.visibleMonsters[g],k=g<9?String(g+1):String.fromCharCode(97+g-9),q[k]=["attack",n.x,n.y],j.showTarget(n.x,n.y,k);n=null;h("pick the target (1\u2013"+k+").")}else n=e.level.visibleMonsters[0];if(n){e.attack(n,!0);if(e.hasHorseshoe)e.usesHorseshoe=
!0;d=!0}break;case "wait":d=!0;break;case "autowait":h("still waiting, press c to cancel.");a(!0);break;case "autoexplore":(c=e.level.autoexplore(e))?(b(c),f.push(["autoexplore"])):h("level completely explored.")}}h.async(!0);e.steps++;e.dungeon.spawnMonster(e);for(g=0;g<e.level.npc.length;g++)if(n=e.level.npc[g],n.speed)for(n.movesLeft=(n.movesLeft||0)+1;n.movesLeft>=n.speed;)n.monsterAI(e),n.movesLeft-=n.speed;else n.monsterAI(e);e.handleTimeouts();e.usesHorseshoe=!1;h.async(!1);d=e.level.draw(j,
e);j.runAnimations();h.clearQueue();d&&(f=[]);e.health===0&&(f=[],l=!0);e.luckyCharms===3&&(h("you found all lucky charms and win the game.","b"),l=!0);l&&h(e.getResult());f.length>0&&(s=setTimeout(i,m))}var f=[],s,q,m=200,e,l=!1,j=new t;return{init:function(a){j.loadSprites(function(){e=a;document.addEventListener("keydown",k);j.canvas.addEventListener("click",g);document.getElementById("inv").addEventListener("click",d);e.level.draw(j,e);h("welcome. Find all three lucky charms to win.","b")})}}}();
(function(){var c=new y,c=new z(c);A.init(c)})()})();
</script>
</body></html>