<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<title>Untitled game</title>
<meta name="viewport" content="width=device-width">
<style>
html{font-family:sans-serif}#canvas{image-rendering:-moz-crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;image-rendering:pixelated;cursor:pointer}#log{overflow-y:scroll;height:4.5em;line-height:1.5em}#log li{display:block}</style>
</head><body>
<canvas id="canvas" moz-opaque></canvas>
<ol id="log" reversed></ol>
<p>Luck: <span id="luck"></span><br>
<canvas id="luck-canvas" moz-opaque></canvas></p>
<section>
<h2>Help</h2>
<p>Use number pad to move (or arrow keys but without diagonal movement), hold shift to walk to next wall. Or click on a place to go to (if you have seen it before).</p>
<p>Press x to automatically explore the map.</p>
<p>Press w to wait a turn, or W to wait until you see an enemy.</p>
<p>To attack an enemy, press f for a ranged attack, or walk into it for a melee attack. Or just click on it.</p>
</section>
<script>
(function(){var q,t,u,v,w,s,x,y,z;q=function(){function b(c){var b;h?j.push(c):(b=document.createElement("li"),b.textContent=c.charAt(0).toUpperCase()+c.slice(1),a.insertBefore(b,a.firstChild))}var a=document.getElementById("log"),j=[],h=!1;b.async=function(a){h=a};b.clearQueue=function(){j.forEach(function(a){b(a)});j=[]};return b}();t=function(){function b(a,j){a=Math.ceil(a);j=Math.floor(j);return Math.floor(a+Math.random()*(j+1-a))}function a(a,j,b,d){function f(a,i){var j,e;for(j=0;j<a.w;j++)for(e=
0;e<a.h;e++)p[e+a.y+1][j+a.x+1]=i}var i,e,r,p=[];for(e=0;e<c+2;e++){r=[];for(i=0;i<h+2;i++)r.push("#");p.push(r)}for(i=0;i<j.length;i++)f(j[i]," ");for(i=0;i<a.length;i++)f(a[i],".");p[d+1][b+1]="*";return p.map(function(a){return a.join("")}).join("\n")}function j(a,j,c){var h,d,i;Math.random()<0.5?(h=a,a=j):h=j;for(j=0;j<f;j++){d=2*b(h.x/2,(h.x+h.w-1)/2);i=2*b(a.y/2,(a.y+a.h-1)/2);var e;a:{e=c;for(var r=d,p=i,o=void 0,o=0;o<e.length;o++)if((r===e[o].x-1||r===e[o].x+e[o].w)&&e[o].y-1<=p&&p<=e[o].y+
e[o].h||(p===e[o].y-1||p===e[o].y+e[o].h)&&e[o].x-1<=r&&r<=e[o].x+e[o].w){e=!0;break a}e=!1}if(!e)break}c={x:d,y:Math.min(h.y,i),w:1,h:Math.abs(h.y-i)+1};d={x:Math.min(a.x,d),y:i,w:Math.abs(a.x-d)+1,h:1};return[c,d]}var h=50,c=20,d=0.3*h*c,f=1E4;return function(f,m){f===-1?(f=b(0,h-1),m=b(0,c-1)):(f--,m--);var g=[],n,k,i;a:{n=f;i=m;var e;for(k=0;k<1E4;k++)if(e={x:b(0,n),y:b(0,i),w:b(4,12),h:b(4,8)},e.x+e.w<=h&&e.y+e.h<=c&&e.x+e.w>n&&e.y+e.h>i){k=e;break a}k={x:n,y:i,w:1,h:1}}i=k.w*k.h;g.push(k);for(n=
0;n<1E4;n++){a:{k=g;var r=e=void 0;e={x:b(0,h-4),y:b(0,c-4),w:b(4,12),h:b(4,8)};if(!(e.x+e.w>h)&&!(e.y+e.h>c)){for(r=0;r<k.length;r++){var p;p=k[r];var o=e;p=Math.abs(p.x-o.x)>(p.x<o.x?p.w:o.w)?!1:Math.abs(p.y-o.y)>(p.y<o.y?p.h:o.h)?!1:!0;if(p){k=void 0;break a}}k=e}else k=void 0}if(k&&(i+=k.w*k.h,g.push(k),i>=d))break}i=[];for(n=1;n<g.length;n++)i=i.concat(j(g[b(0,n-1)],g[n],g));return a(g,i,f,m)}}();u=function(){function b(a){this.canvas=document.getElementById(a);this.ctx=this.canvas.getContext("2d",
{alpha:!1});this.f=1.5}b.prototype.setSize=function(a,j){if(this.canvas.width!==a*16)this.canvas.width=a*16,this.canvas.style.width=a*16*this.f+"px";if(this.canvas.height!==j*16)this.canvas.height=j*16,this.canvas.style.height=j*16*this.f+"px"};b.prototype.getTile=function(a,j){a=(a-this.canvas.offsetLeft+document.documentElement.scrollLeft)/this.f;j=(j-this.canvas.offsetTop+document.documentElement.scrollTop)/this.f;a=Math.floor(a/16);j=Math.floor(j/16);return[a,j]};return b}();v=function(){function b(a){this.type=
a;this.seen=!1}b.draw={".":function(a){a.fillStyle="rgba(128,128,128,0.75)";a.fillRect(0,0,16,16)}," ":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16)},"#":function(a){a.fillStyle="brown";a.fillRect(0,0,16,16)}};b.prototype.draw=function(a,j){if(j)this.seen=!0;if(this.seen&&(b.draw[this.type](a.ctx),!j))b.draw["."](a.ctx)};b.prototype.isOpen=function(){return this.type!=="#"};b.prototype.isSeen=function(){return this.seen};return b}();w=function(){function b(a){this.tiles=a.split("\n").map(function(a){return a.split("").map(function(a){return new v(a)})});
this.npc=[]}function a(a,b,c,d,f){function l(i,e,c){for(var i={x:i,y:e,prev:c,g:c?c.g+1:0,h:Math.max(Math.abs(i-a),Math.abs(e-b))},d,c=i.g+i.h,e=0;e<m.length;e++)if(d=m[e].g+m[e].h,c<d||c===d&&i.h<m[e].h){m.splice(e,0,i);return}m.push(i)}var m=[],g={},n,k;for(l(c,d);m.length;)if(c=m.shift(),d=c.x+","+c.y,!g[d]){g[d]=c;if(c.x===a&&c.y===b)break;n=f(c.x,c.y);for(k=0;k<n.length;k++)d=n[k][0]+","+n[k][1],g[d]||l(n[k][0],n[k][1],c)}if(c=g[a+","+b]){for(f=[];c;)f.push([c.x,c.y]),c=c.prev;return f}}b.prototype.draw=
function(a,b){var c=this.tiles.length,d=this.tiles[0].length,f,l,m=!1;a.setSize(d,c);a.ctx.fillStyle="#000";a.ctx.fillRect(0,0,d*16,c*16);for(f=0;f<d;f++)for(l=0;l<c;l++)a.ctx.save(),a.ctx.translate(f*16,l*16),this.tiles[l][f].draw(a,b.canSee(f,l)),a.ctx.restore();this.visibleMonsters=[];for(c=0;c<this.npc.length;c++)d=this.npc[c],f=d.x,l=d.y,b.canSee(f,l)?(a.ctx.save(),a.ctx.translate(f*16,l*16),d.draw(a),a.ctx.restore(),d.seen||q(d.seenBefore?"you see "+d.getDesc(!0)+" again.":"you see "+d.getDesc()+
"."),d.seen=!0,m=d.seenBefore=!0,this.visibleMonsters.push(d)):d.seen=!1;a.ctx.save();a.ctx.translate(b.x*16,b.y*16);b.draw(a);a.ctx.restore();b.showLuck();return m};b.prototype.isOpen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isOpen()};b.prototype.hasBeenSeen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isSeen()};b.prototype.monsterAt=function(a,b){var c,d;for(c=0;c<this.npc.length;c++)if(d=
this.npc[c],d.x===a&&d.y===b)return d};b.prototype.findFreeTile=function(a){var b,c,d;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*this.tiles[0].length),d=Math.floor(Math.random()*this.tiles.length),this.isOpen(c,d)&&!this.monsterAt(c,d)&&!a.canSee(c,d))return[c,d]};b.prototype.spawnMonster=function(a,b){var c;if(b||!(Math.random()>0.05))(c=this.findFreeTile(a))&&this.npc.push(new x("x",c[0],c[1],this))};b.prototype.removeMonster=function(a){this.npc.splice(this.npc.indexOf(a),1)};b.prototype.findPath=
function(b,h,c,d,f){var l=this;return a(b,h,c,d,function(a,b){return[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]].map(function(c){return[a+c[0],b+c[1]]}).filter(function(a){return l.isOpen(a[0],a[1])&&(!f||l.hasBeenSeen(a[0],a[1]))})})};b.prototype.autoexplore=function(a){var b=Infinity,c,d,f,l,m;for(l=0;l<this.tiles[0].length;l++)for(m=0;m<this.tiles.length;m++)this.isOpen(l,m)&&!this.hasBeenSeen(l,m)&&(f=Math.max(Math.abs(a.x-l),Math.abs(a.y-m)),f<b&&(c=l,d=m,b=f));if(b!==Infinity&&(a=
this.findPath(a.x,a.y,c,d))){for(b=0;b<a.length;b++)if(!this.hasBeenSeen(a[b][0],a[b][1])){a.length=b+1;break}return a}};return b}();s=function(){function b(){}b.draw={"@":function(a){a.fillStyle="blue";a.fillRect(4,4,8,8)},x:function(a){a.fillStyle="green";a.fillRect(4,4,8,8)}};b.prototype.drawHealth=function(a,b,h){var c=this.health/this.maxHealth,d;d="hsl("+Math.round(140*c*c)+",100%,30%)";a.fillStyle=d;a.fillRect(0,0,b,h);a.fillStyle="#000";c=Math.round((b-2)*(1-c));a.fillRect(b-c-1,1,c,h-2);
return d};b.prototype.draw=function(a){b.draw[this.type](a.ctx);this.type!=="@"&&this.health<this.maxHealth&&(a.ctx.translate(2,2),this.drawHealth(a.ctx,12,4))};b.prototype.moveTo=function(a,b){this.x=a;this.y=b};b.prototype.moveRel=function(a,b){var h=this.x+a,c=this.y+b,d;if(d=this.level.monsterAt(h,c))return this.attack(d),!0;return this.level.isOpen(h,c)?(this.moveTo(h,c),!0):!1};b.prototype.attack=function(a,b){if(a.health!==0)if(b)q("you try to hit "+a.getDesc(!0)+", but you miss.");else if(this.type===
"@"?q("you hit "+a.getDesc(!0)+"."):q(this.getDesc(!0)+" hits you."),a.health-=1,a.health<=0)a.health=0,a.die()};b.prototype.die=function(){this.type==="@"?q("you are out of luck and lose the game."):(q(this.getDesc(!0)+" vanishes."),this.level.removeMonster(this))};return b}();x=function(){function b(a,b,h,c){this.type=a;this.x=b;this.y=h;this.level=c;this.seenBefore=this.seen=!1;this.maxHealth=this.health=10}b.prototype=new s;b.desc={x:["a green monster","the green monster"]};b.prototype.getDesc=
function(a){return b.desc[this.type][a?1:0]};b.prototype.walkRandom=function(){var a,b;do a=Math.floor(Math.random()*3)-1,b=Math.floor(Math.random()*3)-1;while(!this.level.isOpen(this.x+a,this.y+b));this.level.monsterAt(this.x+a,this.y+b)||this.moveRel(a,b)};b.prototype.huntPlayer=function(a){a=this.level.findPath(this.x,this.y,a.x,a.y);!a||a.length<2||this.level.monsterAt(a[1][0],a[1][1])?this.walkRandom():this.moveRel(a[1][0]-a[0][0],a[1][1]-a[0][1])};b.prototype.monsterAI=function(a){this.seenBefore&&
(Math.abs(a.x-this.x)<=1&&Math.abs(a.y-this.y)<=1?this.attack(a):this.seen?this.huntPlayer(a):this.walkRandom())};return b}();y=function(){function b(a,b,h){this.type="@";this.x=a;this.y=b;this.level=h;this.sightRadius=3;this.maxHealth=this.health=77}b.prototype=new s;b.prototype.showLuck=function(){if(!this.luckOutput)this.luckOutput=document.getElementById("luck"),this.luckCanvas=document.getElementById("luck-canvas").getContext("2d",{alpha:!1}),this.luckCanvas.canvas.width=100,this.luckCanvas.canvas.height=
10;this.luckOutput.style.color=this.drawHealth(this.luckCanvas,100,10);this.luckOutput.textContent=this.health+"/"+this.maxHealth};b.prototype.canSee=function(a,b){var h=a-this.x,c=b-this.y,d,f,l;this.level.isOpen(a,b)||(h>0?h-=0.5:h<0&&(h+=0.5),c>0?c-=0.5:c<0&&(c+=0.5));if(h*h+c*c>this.sightRadius*this.sightRadius)return!1;for(d=0;d<this.sightRadius;d++){f=Math.round(this.x+d*h/this.sightRadius);l=Math.round(this.y+d*c/this.sightRadius);if(f===a&&l===b)break;if(!this.level.isOpen(f,l))return!1}return!0};
return b}();z=function(){function b(a,b,c){var d;if(c){c=g.x+a;for(d=g.y+b;g.level.isOpen(c,d);)f.push(["move",a,b]),c+=a,d+=b}else f.push(["move",a,b])}function a(a){var b,c,d;for(b=0;b<a.length;b++)b>0&&f.push(["move",a[b][0]-c,a[b][1]-d]),c=a[b][0],d=a[b][1]}function j(a){var b;for(b=0;b<(a?10:1);b++)f.push(["wait"]);a&&f.push(["autowait"])}function h(a){switch(a.key&&a.key!=="Unidentified"?{Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown"}[a.key]||a.key:{12:"Clear",33:"PageUp",
34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown"}[a.which]||String.fromCharCode(a.which).toLowerCase()){case "1":case "End":b(-1,1,a.shiftKey);break;case "2":case "ArrowDown":b(0,1,a.shiftKey);break;case "3":case "PageDown":b(1,1,a.shiftKey);break;case "4":case "ArrowLeft":b(-1,0,a.shiftKey);break;case "5":case "Clear":case "w":case "W":j(a.shiftKey);break;case "6":case "ArrowRight":b(1,0,a.shiftKey);break;case "7":case "Home":b(-1,-1,a.shiftKey);break;case "8":case "ArrowUp":b(0,
-1,a.shiftKey);break;case "9":case "PageUp":b(1,-1,a.shiftKey);break;case "c":f=[];break;case "f":f.push(["attack"]);break;case "x":f.push(["autoexplore"])}!a.ctrlKey&&!a.altKey&&a.preventDefault();d()}function c(b){var c,h;c=k.getTile(b.clientX,b.clientY);b=c[0];c=c[1];g.level.hasBeenSeen(b,c)?g.level.isOpen(b,c)?g.canSee(b,c)&&g.level.monsterAt(b,c)?Math.abs(b-g.x)<=1&&Math.abs(c-g.y)<=1?f.push(["move",b-g.x,c-g.y]):f.push(["attack"]):h=g.level.findPath(g.x,g.y,b,c,!0):q("you cannot go there."):
q("you don\u2019t know how to go there.");h&&a(h);d()}function d(){var b,c=!1;for(clearTimeout(l);!c;){if(f.length===0)return;b=f.shift();if(n)return;switch(b[0]){case "move":c=g.moveRel(b[1],b[2]);break;case "attack":if(b=g.level.visibleMonsters[0])g.attack(b,!0),c=!0;break;case "wait":c=!0;break;case "autowait":q("still waiting, press c to cancel.");j(!0);break;case "autoexplore":(b=g.level.autoexplore(g))?(a(b),f.push(["autoexplore"])):q("level completely explored")}}q.async(!0);g.level.spawnMonster(g);
for(c=0;c<g.level.npc.length;c++)if(b=g.level.npc[c],b.speed)for(b.movesLeft=(b.movesLeft||0)+1;b.movesLeft>=b.speed;)b.monsterAI(g),b.movesLeft-=b.speed;else b.monsterAI(g);q.async(!1);c=g.level.draw(k,g);q.clearQueue();c&&(f=[]);g.health===0&&(f=[],n=!0);f.length>0&&(l=setTimeout(d,m))}var f=[],l,m=200,g,n=!1,k=new u("canvas");return{init:function(a){g=a;document.addEventListener("keydown",h);k.canvas.addEventListener("click",c);g.level.draw(k,g)}}}();(function(){var b=new w(t(3,3).replace(/[*.]/g,
" ")),a=new y(3,3,b);b.spawnMonster(a,!0);z.init(a)})()})();
</script>
</body></html>