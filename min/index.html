<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<title>Lord Balsekilâ€™s Lairs of Bad Luck</title>
<meta name="viewport" content="width=device-width">
<style>
html{font-family:sans-serif}#canvas{image-rendering:-moz-crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;image-rendering:pixelated;cursor:pointer}#log{overflow-y:scroll;height:4.5em;line-height:1.5em}#log li{display:block}.mushroom{cursor:pointer}</style>
</head><body>
<ol id="log" reversed></ol>
<canvas id="canvas" moz-opaque></canvas>
<p>Luck: <span id="luck"></span><br>
<canvas id="luck-canvas" moz-opaque></canvas></p>
<p id="inv"></p>
<section>
<h2>Help</h2>
<p>Use number pad to move (or arrow keys but without diagonal movement), hold shift to walk to next wall. Or click on a place to go to (if you have seen it before).</p>
<p>To climb up and down ladders use &lt; and &gt;. Or just click on it.</p>
<p>Press x to automatically explore the map.</p>
<p>Press w to wait a turn, or W to wait until you see an enemy.</p>
<p>To attack an enemy, press f for a ranged attack, or walk into it for a melee attack. Or just click on it.</p>
<p>Press e to eat a mushroom, or click it in your inventory.</p>
</section>
<script>
(function(){var g,v,w,x,y,z,u,t,A,B;g=function(){function b(b){var d;c?j.push(b):(d=document.createElement("li"),d.textContent=b.charAt(0).toUpperCase()+b.slice(1),a.insertBefore(d,a.firstChild))}var a=document.getElementById("log"),j=[],c=!1;b.async=function(a){c=a};b.clearQueue=function(){j.forEach(function(a){b(a)});j=[]};return b}();v=function(){function b(a,j){a=Math.ceil(a);j=Math.floor(j);return Math.floor(a+Math.random()*(j+1-a))}function a(a,j,d,r){function e(a,j){var c,b;for(c=0;c<a.w;c++)for(b=
0;b<a.h;b++)p[b+a.y+1][c+a.x+1]=j}var m,h,s,p=[];for(h=0;h<f+2;h++){s=[];for(m=0;m<c+2;m++)s.push("#");p.push(s)}for(h=0;h<j.length;h++)e(j[h]," ");for(h=0;h<a.length;h++)e(a[h],".");p[r+1][d+1]="<";h=a.length===1?0:b(1,a.length-1);m=b(0,a[h].w-1)+a[h].x;h=b(0,a[h].h-1)+a[h].y;p[h+1][m+1]=">";return p.map(function(a){return a.join("")}).join("\n")}function j(a,j,c){var f,e,d;Math.random()<0.5?(f=a,a=j):f=j;for(j=0;j<l;j++){e=2*b(f.x/2,(f.x+f.w-1)/2);d=2*b(a.y/2,(a.y+a.h-1)/2);var h;a:{h=c;for(var s=
e,p=d,o=void 0,o=0;o<h.length;o++)if((s===h[o].x-1||s===h[o].x+h[o].w)&&h[o].y-1<=p&&p<=h[o].y+h[o].h||(p===h[o].y-1||p===h[o].y+h[o].h)&&h[o].x-1<=s&&s<=h[o].x+h[o].w){h=!0;break a}h=!1}if(!h)break}c={x:e,y:Math.min(f.y,d),w:1,h:Math.abs(f.y-d)+1};e={x:Math.min(a.x,e),y:d,w:Math.abs(a.x-e)+1,h:1};return[c,e]}var c=50,f=20,d=0.3*c*f,l=1E4;return function(i,k){i===-1?(i=b(0,c-1),k=b(0,f-1)):(i--,k--);var l=[],g,e,m;a:{g=i;m=k;var h;for(e=0;e<1E4;e++)if(h={x:b(0,g),y:b(0,m),w:b(4,12),h:b(4,8)},h.x+
h.w<=c&&h.y+h.h<=f&&h.x+h.w>g&&h.y+h.h>m){e=h;break a}e={x:g,y:m,w:1,h:1}}m=e.w*e.h;l.push(e);for(g=0;g<1E4;g++){a:{e=l;var s=h=void 0;h={x:b(0,c-4),y:b(0,f-4),w:b(4,12),h:b(4,8)};if(!(h.x+h.w>c)&&!(h.y+h.h>f)){for(s=0;s<e.length;s++){var p;p=e[s];var o=h;p=Math.abs(p.x-o.x)>(p.x<o.x?p.w:o.w)?!1:Math.abs(p.y-o.y)>(p.y<o.y?p.h:o.h)?!1:!0;if(p){e=void 0;break a}}e=h}else e=void 0}if(e&&(m+=e.w*e.h,l.push(e),m>=d))break}m=[];for(g=1;g<l.length;g++)m=m.concat(j(l[b(0,g-1)],l[g],l));return a(l,m,i,k)}}();
w=function(){function b(a){this.canvas=document.getElementById(a);this.ctx=this.canvas.getContext("2d",{alpha:!1});this.f=1.5}b.prototype.setSize=function(a,j){if(this.canvas.width!==a*16)this.canvas.width=a*16,this.canvas.style.width=a*16*this.f+"px";if(this.canvas.height!==j*16)this.canvas.height=j*16,this.canvas.style.height=j*16*this.f+"px"};b.prototype.getTile=function(a,j){a=(a-this.canvas.offsetLeft+document.documentElement.scrollLeft)/this.f;j=(j-this.canvas.offsetTop+document.documentElement.scrollTop)/
this.f;a=Math.floor(a/16);j=Math.floor(j/16);return[a,j]};b.prototype.showTarget=function(a,j,c){a=a*16+8;j=j*16+8;this.ctx.fillStyle="rgba(255,255,255,0.75)";this.ctx.fillRect(a,j,8,8);this.ctx.font="10px monospace";this.ctx.textAlign="center";this.ctx.fillStyle="#000";this.ctx.fillText(c,a+4,j+8)};b.prototype.clearTargets=function(){};return b}();x=function(){function b(a){this.type=a;this.seen=!1}b.draw={".":function(a){a.fillStyle="rgba(128,128,128,0.75)";a.fillRect(0,0,16,16)}," ":function(a){a.fillStyle=
"#fff";a.fillRect(0,0,16,16)},"#":function(a){a.fillStyle="brown";a.fillRect(0,0,16,16)},">":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16);a.strokeStyle="brown";a.beginPath();a.moveTo(7.5,2);a.lineTo(7.5,14);a.lineTo(3.5,10);a.lineTo(11.5,10);a.lineTo(7.5,14);a.stroke()},"<":function(a){a.fillStyle="#fff";a.fillRect(0,0,16,16);a.strokeStyle="brown";a.beginPath();a.moveTo(7.5,14);a.lineTo(7.5,2);a.lineTo(3.5,6);a.lineTo(11.5,6);a.lineTo(7.5,2);a.stroke()},"%":function(a){a.fillStyle="#8f8";
a.fillRect(0,0,16,16)},F:function(a){a.fillStyle="#f88";a.fillRect(0,0,16,16)},"(":function(a){a.fillStyle="#ff0";a.fillRect(0,0,16,16)},"*":function(a){a.fillStyle="#f0f";a.fillRect(0,0,16,16)},")":function(a){a.fillStyle="#f80";a.fillRect(0,0,16,16)}};b.prototype.draw=function(a,j){if(j)this.seen=!0;if(this.seen&&(b.draw[this.type](a.ctx),!j))b.draw["."](a.ctx)};b.prototype.isOpen=function(){return this.type!=="#"};b.prototype.isSeen=function(){return this.seen};b.prototype.getType=function(){return this.type};
b.prototype.takeItem=function(a){this.type=a||" "};return b}();y=function(){function b(a,c){this.tiles=a.split("\n").map(function(a){return a.split("").map(function(a){return new x(a)})});this.npc=[];this.depth=c}function a(a,c,b,d,g){function i(b,d,e){for(var b={x:b,y:d,prev:e,g:e?e.g+1:0,h:Math.max(Math.abs(b-a),Math.abs(d-c))},f,e=b.g+b.h,d=0;d<k.length;d++)if(f=k[d].g+k[d].h,e<f||e===f&&b.h<k[d].h){k.splice(d,0,b);return}k.push(b)}var k=[],q={},r,e;for(i(b,d);k.length;)if(b=k.shift(),d=b.x+","+
b.y,!q[d]){q[d]=b;if(b.x===a&&b.y===c)break;r=g(b.x,b.y);for(e=0;e<r.length;e++)d=r[e][0]+","+r[e][1],q[d]||i(r[e][0],r[e][1],b)}if(b=q[a+","+c]){for(g=[];b;)g.push([b.x,b.y]),b=b.prev;return g}}b.prototype.draw=function(a,c){var b=this.tiles.length,d=this.tiles[0].length,l,i,k=!1;a.setSize(d,b);a.ctx.fillStyle="#000";a.ctx.fillRect(0,0,d*16,b*16);for(l=0;l<d;l++)for(i=0;i<b;i++)a.ctx.save(),a.ctx.translate(l*16,i*16),this.tiles[i][l].draw(a,c.canSee(l,i)),a.ctx.restore();this.visibleMonsters=[];
for(b=0;b<this.npc.length;b++)d=this.npc[b],l=d.x,i=d.y,c.canSee(l,i)?(a.ctx.save(),a.ctx.translate(l*16,i*16),d.draw(a),a.ctx.restore(),d.seen||g(d.seenBefore?"you see "+d.getDesc(!0)+" again.":"you see "+d.getDesc()+"."),d.seen=!0,k=d.seenBefore=!0,this.visibleMonsters.push(d)):d.seen=!1;a.ctx.save();a.ctx.translate(c.x*16,c.y*16);c.draw(a);a.ctx.restore();c.showLuck();return k};b.prototype.isOpen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isOpen()};
b.prototype.hasBeenSeen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isSeen()};b.prototype.getType=function(a,b){return this.tiles[b][a].getType()};b.prototype.takeItem=function(a,b,f){return this.tiles[b][a].takeItem(f)};b.prototype.monsterAt=function(a,b){var f,d;for(f=0;f<this.npc.length;f++)if(d=this.npc[f],d.x===a&&d.y===b)return d};b.prototype.findFirst=function(a){var b,f;for(b=0;b<this.tiles[0].length;b++)for(f=0;f<this.tiles.length;f++)if(this.tiles[f][b].getType()===
a)return[b,f]};b.prototype.findFreeTile=function(a){var b,f,d;for(b=0;b<1E4;b++)if(f=Math.floor(Math.random()*this.tiles[0].length),d=Math.floor(Math.random()*this.tiles.length),this.isOpen(f,d)&&!this.monsterAt(f,d)&&!a.canSee(f,d))return[f,d]};b.prototype.addMonster=function(a,b,f){a.place(b,f,this);this.npc.push(a)};b.prototype.removeMonster=function(a){this.npc.splice(this.npc.indexOf(a),1)};b.prototype.leave=function(){var a;for(a=0;a<this.npc.length;a++)this.npc[a].seen=!1};b.prototype.findPath=
function(b,c,f,d,g){var i=this;return a(b,c,f,d,function(a,b){return[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]].map(function(j){return[a+j[0],b+j[1]]}).filter(function(a){return i.isOpen(a[0],a[1])&&(!g||i.hasBeenSeen(a[0],a[1]))})})};b.prototype.autoexplore=function(a){var b=Infinity,f,d,g,i,k;for(i=0;i<this.tiles[0].length;i++)for(k=0;k<this.tiles.length;k++)this.isOpen(i,k)&&!this.hasBeenSeen(i,k)&&(g=Math.max(Math.abs(a.x-i),Math.abs(a.y-k)),g<b&&(f=i,d=k,b=g));if(b!==Infinity&&(a=
this.findPath(a.x,a.y,f,d))){for(b=0;b<a.length;b++)if(!this.hasBeenSeen(a[b][0],a[b][1])){a.length=b+1;break}return a}};return b}();z=function(){function b(){var a,b,c;this.items=[[],[],[]];this.items[Math.floor(Math.random()*2)].push("(");this.items[Math.floor(Math.random()*2)].push(")");this.items[Math.floor(Math.random()*2)].push("*");this.items[Math.floor(Math.random()*2)].push("*");for(a=0;a<this.items.length;a++){c=2+Math.floor(Math.random()*2);for(b=0;b<c;b++)this.items[a].push("%");c=1+Math.floor(Math.random()*
2);for(b=0;b<c;b++)this.items[a].push("F")}this.levels=[this.createLevel(3,3,0)];this.currentLevel=0;this.henchmen=[];this.maxHenchmen=1}b.prototype.init=function(a){a.place(3,3,this.levels[0]);a.missedEarlyLuckyCharms=2;this.initMonsters(a)};b.prototype.createLevel=function(a,b,c){function f(a){var b,j;for(b=0;b<1E4;b++)if(j=Math.floor(Math.random()*d.length),d.charAt(j)==="."){d=d.slice(0,j)+a+d.slice(j+1);return}d=d.replace(/./,a)}for(var d=v(a,b),a=0;a<this.items[c].length;a++)f(this.items[c][a]);
d=d.replace(/\./g," ");c===0?d=d.replace("<"," "):c===this.items.length-1&&(d=d.replace(">"," "));return new y(d,c)};b.prototype.goUp=function(a){g("you climb up the ladder.");this.levels[this.currentLevel].leave();this.currentLevel--;a.level=this.levels[this.currentLevel]};b.prototype.goDown=function(a){var b;g("you climb down the ladder.");this.levels[this.currentLevel].leave();this.currentLevel++;this.levels[this.currentLevel]||(b=this.createLevel(a.x,a.y,this.currentLevel),this.levels.push(b));
a.level=this.levels[this.currentLevel];b&&this.initMonsters(a)};b.prototype.createHenchman=function(){var a;if(this.henchmen.length===this.maxHenchmen)return new t("n");a=new t("&1");this.henchmen.push(a);a.desc[1]+=this.henchmen.length;return a};b.prototype.createRandomMonster=function(a){for(var b=Object.keys(a),c=Math.random();b.length>1&&a[b[0]]<c;)c-=a[b[0]],b.shift();a=b[0];return a==="&1"?this.createHenchman():new t(a)};b.prototype.initMonsters=function(a){var b,c=this.levels[this.currentLevel];
if(this.currentLevel===2)b=c.findFirst("<"),c.isOpen(b[0]-1,b[1])?b[0]--:b[0]++,c.addMonster(new t("@2"),b[0],b[1]),b=c.findFreeTile(a),c.addMonster(new t("&2"),b[0],b[1]),this.transferHenchmen(a,c),this.maxHenchmen=2,b=c.findFreeTile(a),c.addMonster(this.createHenchman(),b[0],b[1]);(b=c.findFreeTile(a))&&c.addMonster(this.createRandomMonster({x:0.5,"&1":0.5}),b[0],b[1])};b.prototype.spawnMonster=function(a){var b=this.levels[this.currentLevel];Math.random()>0.05||(a=b.findFreeTile(a))&&b.addMonster(this.createRandomMonster({x:0.75,
n:0.25}),a[0],a[1])};b.prototype.transferHenchmen=function(a,b){var c,f,d,l=!1;if(!this.henchmenTransferred){for(c=0;c<this.henchmen.length;c++)if(f=this.henchmen[c],f.health!==0&&(d=b.findFreeTile(a)))f.level.removeMonster(f),b.addMonster(f,d[0],d[1]),l=!0;l&&g("you sense that all of Lord Balsekil\u2019s henchmen rushed to his help.");this.henchmenTransferred=!0}};return b}();u=function(){function b(){}b.draw={"@":function(a){a.fillStyle="blue";a.fillRect(4,4,8,8)},x:function(a){a.fillStyle="green";
a.fillRect(4,4,8,8)},"@2":function(a){a.fillStyle="black";a.fillRect(4,4,8,8)},n:function(a){a.fillStyle="silver";a.fillRect(4,4,8,8)},"&1":function(a){a.fillStyle="orange";a.fillRect(4,4,8,8)},"&2":function(a){a.fillStyle="red";a.fillRect(4,4,8,8)}};b.prototype.init=function(a){this.health=a.health||10;this.maxHealth=a.health||10;this.experience=a.experience||1;this.block=a.block||0.1;this.minAttack=a.minAttack||1;this.maxAttack=a.maxAttack||2;if(a.speed)this.speed=1/a.speed;this.aiMode=a.aiMode;
if(a.desc)this.desc=JSON.parse(JSON.stringify(a.desc));this.attackName=a.attackName};b.prototype.place=function(a,b,c){this.x=a;this.y=b;this.level=c};b.prototype.drawHealth=function(a,b,c){var f=this.health/this.maxHealth,d;d="hsl("+Math.round(140*f*f)+",100%,30%)";a.fillStyle=d;a.fillRect(0,0,b,c);a.fillStyle="#000";f=Math.round((b-2)*(1-f));a.fillRect(b-f-1,1,f,c-2);return d};b.prototype.draw=function(a){b.draw[this.type](a.ctx);!this.isPlayer&&this.health<this.maxHealth&&(a.ctx.translate(2,2),
this.drawHealth(a.ctx,12,4))};b.prototype.moveTo=function(a,b){var c;this.x=a;this.y=b;this.isPlayer&&(c=this.level.getType(a,b),c!==" "&&(c=this.handleItem(c))&&this.level.takeItem(a,b))};b.prototype.moveRel=function(a,b){var c=this.x+a,f=this.y+b,d;if(d=this.level.monsterAt(c,f))return this.attack(d),!0;return this.level.isOpen(c,f)?(this.moveTo(c,f),!0):!1};b.prototype.rangedFails=function(a){return Math.random()<(Math.pow(1.3,a/2)-1)/this.experience};b.prototype.blockAttack=function(){return Math.random()<
this.block*this.experience*(this.hasHorseshoe&&!this.usesHorseshoe?3:1)};b.prototype.getAttackDamage=function(){return Math.round((this.minAttack+Math.random()*(this.maxAttack-this.minAttack))*this.experience)};b.prototype.improveExperience=function(a){this.luckyMushroomTimeout&&(this.experience/=2);a=this.experience*Math.pow(2,a/500);a>2&&(a=2);Math.floor(a*10)!==Math.floor(this.experience*10)&&g("you feel more experienced now.");this.experience=a;this.luckyMushroomTimeout&&(this.experience*=2)};
b.prototype.getAttackName=function(a,b){var c;return this.isPlayer?(c=a?this.hasHorseshoe?"throw your horseshoe at":"yell your lucky number at":"hit",b&&(c="try to "+c),"you "+c+" "):(c=this.attackName?this.attackName[b?0:1]:b?"tries to attack":"attacks",this.getDesc(!0)+" "+c+" ")};b.prototype.attack=function(a,b){function c(a,b){var c=a.x-b.x,j=a.y-b.y;return Math.sqrt(c*c+j*j)}a.health!==0&&(b&&this.rangedFails(c(a,this))?this.isPlayer?g(this.getAttackName(!0,!0)+a.getDesc(!0)+", but miss."):g(this.getAttackName(!0,
!0)+"you, but misses."):b&&this.hasHorseshoe&&a.type==="n"?(g("uh-oh! The mirror-monster shatters!"),a.level.removeMonster(a),this.reduceHealth(20)):a.blockAttack()?this.isPlayer?g(this.getAttackName(b,!0)+a.getDesc(!0)+", but your attack is blocked."):g(this.getAttackName(b,!0)+"you, but you block the attack."):(this.isPlayer?g(this.getAttackName(b)+a.getDesc(!0)+"."):(g(this.getAttackName(b)+"you."),this.type==="B"&&Math.random()<0.2&&(g(this.getDesc(!0)+" hits your eyes."),a.makeBlind())),a.reduceHealth(this.getAttackDamage())&&
this.isPlayer&&this.improveExperience(a.maxHealth)))};b.prototype.reduceHealth=function(a){this.health-=a;if(this.health<=0)return this.health=0,this.die(),!0};b.prototype.die=function(){this.isPlayer?g("you are out of luck and lose the game."):(g(this.getDesc(!0)+" vanishes."),this.type==="&2"&&(this.level.takeItem(this.x,this.y,"*"),g(this.getDesc(!0)+" left back a lucky charm!")),this.level.removeMonster(this))};return b}();t=function(){function b(a){this.type=a;this.seenBefore=this.seen=!1;this.init(b.data[a])}
b.prototype=new u;b.data={x:{desc:["a green monster","the green monster"],attackName:["tries to bite","bites"],speed:0.75},":1":{desc:["a small newt","the small newt"],attackName:["tries to touch","touches"],speed:0.5,maxAttack:1,health:5},":2":{desc:["a newt","the newt"],attackName:["tries to touch","touches"],speed:0.75},":3":{desc:["a large newt","the large newt"],attackName:["tries to touch","touches"]},B1:{desc:["a small crow","the small crow"],attackName:["tries to peck","pecks"],maxAttack:1,
health:5},B2:{desc:["a crow","the crow"],attackName:["tries to peck","pecks"],speed:1.25,maxAttack:1,health:5},B3:{desc:["a large crow","the large crow"],attackName:["tries to peck","pecks"],speed:1.5,health:5},f1:{desc:["a small black cat","the small black cat"],attackName:["tries to hiss at","hisses at"],maxAttack:1,aiMode:"ranged"},f2:{desc:["a black cat","the black cat"],attackName:["tries to hiss at","hisses at"],maxAttack:1,aiMode:"ranged"},f3:{desc:["a large black cat","the large black cat"],
attackName:["tries to hiss at","hisses at"],aiMode:"ranged"},n:{desc:["a mirror monster","the mirror monster"],attackName:["tries to cast an evil look at","casts an evil look at"],aiMode:"ranged",block:0},"&1":{desc:["one of Balsekil\u2019s henchmen","Henchman No. "],aiMode:"meleeRanged",block:0.15,health:15,minAttack:1,maxAttack:3},"&2":{desc:["Lord Balsekil","Lord Balsekil"],aiMode:"meleeRanged",block:0.2,health:25,minAttack:1,maxAttack:5,experience:1.5},"@2":{desc:["a chimney sweep","the chimney sweep"],
aiMode:"hint",block:1}};b.prototype.getDesc=function(a){return this.desc[a?1:0]};b.prototype.walkRandom=function(a){var b,c;do b=Math.floor(Math.random()*3)-1,c=Math.floor(Math.random()*3)-1;while(!this.level.isOpen(this.x+b,this.y+c));!this.level.monsterAt(this.x+b,this.y+c)&&!(a.x===this.x+b&&a.y===this.y+c)&&this.moveRel(b,c)};b.prototype.huntPlayer=function(a){var b=this.level.findPath(this.x,this.y,a.x,a.y);!b||b.length<2||this.level.monsterAt(b[1][0],b[1][1])?this.walkRandom(a):this.moveRel(b[1][0]-
b[0][0],b[1][1]-b[0][1])};b.prototype.meleeAI=function(a){Math.abs(a.x-this.x)<=1&&Math.abs(a.y-this.y)<=1?this.attack(a):this.seen?this.huntPlayer(a):this.walkRandom(a)};b.prototype.rangedAI=function(a){this.seen?this.attack(a,!0):Math.random()<0.5?this.walkRandom(a):this.huntPlayer(a)};b.prototype.meleeRangedAI=function(a){var b=a.x-this.x,c=a.y-this.y;Math.abs(b)<=1&&Math.abs(c)<=1?this.attack(a):b*b+c*c<=4?this.attack(a,!0):this.seen?Math.random()<0.5?this.attack(a,!0):this.huntPlayer(a):this.rangedAI(a)};
b.prototype.hintAI=function(a){var b;if(this.seen)b=a.getHint(),this.lastHint!==b?(g(this.getDesc(!0)+": \u201c"+b+"\u201d"),this.lastHint=b):this.walkRandom(a)};b.prototype.monsterAI=function(a){if(this.seenBefore)switch(this.aiMode){case "ranged":this.rangedAI(a);break;case "meleeRanged":this.meleeRangedAI(a);break;case "hint":this.hintAI(a);break;default:this.meleeAI(a)}};return b}();A=function(){function b(a){this.type="@";this.isPlayer=!0;this.dungeon=a;a.init(this);this.sightRadius=4;this.init({health:77,
maxAttack:2});this.maxDepth=this.steps=0;this.hasHorseshoe=this.hasLamp=!1;this.luckyMushroomTimeout=this.luckyMushrooms=this.luckyCharms=0;this.blind=!1;this.blindTimeout=0}function a(a,b,f,d,g){for(var i=a,k=b,q=Math.abs(f-a),a=a<f?1:-1,r=-Math.abs(d-b),b=b<d?1:-1,e=q+r,m;i!==f||k!==d;){if(!g(i,k))return!1;m=e*2;m>r&&(e+=r,i+=a);m<q&&(e+=q,k+=b)}return!0}b.prototype=new u;b.prototype.showLuck=function(){if(!this.luckOutput)this.luckOutput=document.getElementById("luck"),this.luckCanvas=document.getElementById("luck-canvas").getContext("2d",
{alpha:!1}),this.luckCanvas.canvas.width=100,this.luckCanvas.canvas.height=10;this.luckOutput.style.color=this.drawHealth(this.luckCanvas,100,10);this.luckOutput.textContent=this.health+"/"+this.maxHealth};b.prototype.showInv=function(){var a;a=[this.luckyCharms?this.luckyCharms+" lucky charm(s)":"",this.luckyMushrooms?'<span class="mushroom">'+this.luckyMushrooms+" lucky mushroom(s)</span>":"",this.hasLamp?"a flashlight":"",this.hasHorseshoe?"a horseshoe":""].filter(function(a){return a}).join(", ");
document.getElementById("inv").innerHTML=a?"You have: "+a:""};b.prototype.getHint=function(){var a=[this.missedEarlyLuckyCharms?this.missedEarlyLuckyCharms+" lucky charm(s)":"",this.hasLamp?"":"a flashlight",this.hasHorseshoe?"":"a horseshoe"].filter(function(a){return a}).join(", ");return a?"You should go back, there are useful things above you did not find yet: "+a:"Well done so far! Now find and defeat Lord Balsekil who has the third lucky charm."};b.prototype.getResult=function(){var a=this.experience,
b;this.luckyMushroomTimeout&&(a/=2);a=Math.round(100*(a-1));b=this.luckyCharms*1E3+(this.maxDepth+1)*50+Math.round(a/2)+this.health;return"After "+this.steps+" steps you found "+this.luckyCharms+" lucky charms, reached a depth of "+(this.maxDepth+1)+", and increased your experience by "+a+" %. For this you earn "+b+" points."};b.prototype.canSee=function(b,c){var f=b-this.x,d=c-this.y,g=this.level;this.level.isOpen(b,c)||(f>0?f-=0.5:f<0&&(f+=0.5),d>0?d-=0.5:d<0&&(d+=0.5));return f*f+d*d>this.sightRadius*
this.sightRadius?!1:a(this.x,this.y,b,c,function(a,d){return g.isOpen(a,d)||b===a&&c===d})};b.prototype.handleItem=function(a){var b=!1;if(a==="<")Math.random()<0.3&&(g("you accidentally walked below the ladder."),this.reduceHealth(2));else if(a==="%"){a="you found a four-leave clover, ";if(this.health===this.maxHealth)a+="but you leave it here for later.";else{b=!0;this.health+=7;if(this.health>this.maxHealth)this.health=this.maxHealth;a+="which"+(this.health===this.maxHealth?"":" partially")+" restores your luck."}g(a)}else if(a===
"*")this.level.depth<2&&this.missedEarlyLuckyCharms--,this.luckyCharms++,b=!0,g("you found a lucky charm.");else if(a==="F")this.luckyMushrooms++,b=!0,g("you found a lucky mushroom"+(this.luckyMushrooms===1?", which you can eat to make you very strong for a short time":"")+".");else if(a==="("){this.hasLamp=b=!0;if(!this.blind)this.sightRadius=6;g("you found a flashlight.")}else if(a===")")this.hasHorseshoe=b=!0,this.minAttack=2,this.maxAttack=4,g("you found a horseshoe. From now on you will use it for attacks (it will return like a boomerang), and to defend attacks (but only if you did not just throw it).");
b&&this.showInv();return b};b.prototype.eat=function(){if(this.luckyMushrooms===0)return!1;this.luckyMushrooms--;this.showInv();this.luckyMushroomTimeout===0&&(this.experience*=2,g("you feel very strong!"));this.luckyMushroomTimeout+=Math.floor(4+Math.random()*5);return!0};b.prototype.makeBlind=function(){if(this.blindTimeout===0)this.blind=!0,this.sightRadius=1.5,g("you can hardly see!");this.blindTimeout+=Math.floor(6+Math.random()*8)};b.prototype.handleTimeouts=function(){this.luckyMushroomTimeout>
0&&(this.luckyMushroomTimeout--,this.luckyMushroomTimeout===0&&(this.experience/=2,g("you feel normal again.")));if(this.blindTimeout>0&&(this.blindTimeout--,this.blindTimeout===0))this.sightRadius=this.hasLamp?6:4,g("your eyes are better again.")};b.prototype.goUp=function(){if(this.level.getType(this.x,this.y)==="<")return this.dungeon.goUp(this),!0};b.prototype.goDown=function(){if(this.level.getType(this.x,this.y)===">")return this.dungeon.goDown(this),this.maxDepth=Math.max(this.maxDepth,this.level.depth),
!0};return b}();B=function(){function b(a,b,c){var d;if(c){c=e.x+a;for(d=e.y+b;e.level.isOpen(c,d);)i.push(["move",a,b]),c+=a,d+=b}else i.push(["move",a,b])}function a(a){var b,c,d;for(b=0;b<a.length;b++)b>0&&i.push(["move",a[b][0]-c,a[b][1]-d]),c=a[b][0],d=a[b][1]}function j(a){var b;for(b=0;b<(a?10:1);b++)i.push(["wait"]);a&&i.push(["autowait"])}function c(a){var c;if(!a.ctrlKey&&!a.altKey){if(a.key&&a.key!=="Unidentified")c={Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown"}[a.key]||
a.key;else if(!(c={12:"Clear",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown"}[a.which])){c=a.shiftKey;var d=String.fromCharCode(a.which).toLowerCase();c&&(d={"<":">"}[d]||d.toUpperCase());c=d}i=[];q&&(q[c]&&i.push(q[c]),q=!1,h.clearTargets(),c="");switch(c){case "1":case "End":b(-1,1,a.shiftKey);break;case "2":case "ArrowDown":b(0,1,a.shiftKey);break;case "3":case "PageDown":b(1,1,a.shiftKey);break;case "4":case "ArrowLeft":b(-1,0,a.shiftKey);
break;case "5":case "Clear":case "w":case "W":j(a.shiftKey);break;case "6":case "ArrowRight":b(1,0,a.shiftKey);break;case "7":case "Home":b(-1,-1,a.shiftKey);break;case "8":case "ArrowUp":b(0,-1,a.shiftKey);break;case "9":case "PageUp":b(1,-1,a.shiftKey);break;case "<":i.push(["goUp"]);break;case ">":i.push(["goDown"]);break;case "e":i.push(["eat"]);break;case "f":i.push(["attack"]);break;case "x":i.push(["autoexplore"])}a.preventDefault();l()}}function f(b){var c,d,f;m||(c=h.getTile(b.clientX,b.clientY),
b=c[0],c=c[1],i=[],e.level.hasBeenSeen(b,c)?e.level.isOpen(b,c)?e.canSee(b,c)&&e.level.monsterAt(b,c)?Math.abs(b-e.x)<=1&&Math.abs(c-e.y)<=1?i.push(["move",b-e.x,c-e.y]):i.push(["attack",b,c]):e.x===b&&e.y===c?(d=e.level.getType(b,c),d!=="<"&&d!==">"&&i.push(["wait"])):(d=e.level.getType(b,c),f=e.level.findPath(e.x,e.y,b,c,!0)):g("you cannot go there."):g("you don\u2019t know how to go there."),f&&a(f),d===">"?i.push(["goDown"]):d==="<"&&i.push(["goUp"]),l())}function d(a){a.target.className==="mushroom"&&
(i.push(["eat"]),l())}function l(){var b,c=!1,d,f,n;for(clearTimeout(k);!c;){if(i.length===0)return;b=i.shift();if(m)return;switch(b[0]){case "move":c=e.moveRel(b[1],b[2]);break;case "goUp":c=e.goUp();break;case "goDown":c=e.goDown();break;case "eat":c=e.eat();break;case "attack":if(b[1])for(d=0;d<e.level.visibleMonsters.length;d++)if(n=e.level.visibleMonsters[d],n.x===b[1]&&n.y===b[2])break;else n=null;else if(e.level.visibleMonsters.length>1){q={};for(d=0;d<e.level.visibleMonsters.length;d++)n=
e.level.visibleMonsters[d],f=d<9?String(d+1):String.fromCharCode(97+d-9),q[f]=["attack",n.x,n.y],h.showTarget(n.x,n.y,f);n=null;g("pick the target (1\u2013"+f+").")}else n=e.level.visibleMonsters[0];if(n){e.attack(n,!0);if(e.hasHorseshoe)e.usesHorseshoe=!0;c=!0}break;case "wait":c=!0;break;case "autowait":g("still waiting, press c to cancel.");j(!0);break;case "autoexplore":(b=e.level.autoexplore(e))?(a(b),i.push(["autoexplore"])):g("level completely explored.")}}g.async(!0);e.steps++;e.dungeon.spawnMonster(e);
for(d=0;d<e.level.npc.length;d++)if(n=e.level.npc[d],n.speed)for(n.movesLeft=(n.movesLeft||0)+1;n.movesLeft>=n.speed;)n.monsterAI(e),n.movesLeft-=n.speed;else n.monsterAI(e);e.handleTimeouts();e.usesHorseshoe=!1;g.async(!1);c=e.level.draw(h,e);g.clearQueue();c&&(i=[]);e.health===0&&(i=[],m=!0);e.luckyCharms===3&&(g("you found all lucky charms and win the game."),m=!0);m&&g(e.getResult());i.length>0&&(k=setTimeout(l,r))}var i=[],k,q,r=200,e,m=!1,h=new w("canvas");return{init:function(a){e=a;document.addEventListener("keydown",
c);h.canvas.addEventListener("click",f);document.getElementById("inv").addEventListener("click",d);e.level.draw(h,e);g("welcome. Find all three lucky charms to win.")}}}();(function(){var b=new z,b=new A(b);B.init(b)})()})();
</script>
</body></html>