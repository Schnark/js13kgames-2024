<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<title>Lord Balsekilâ€™s Lairs of Bad Luck</title>
<meta name="viewport" content="width=device-width">
<style>
html{font-family:sans-serif}#wrap{position:relative}#canvas{image-rendering:-moz-crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;image-rendering:pixelated;cursor:pointer}#cover{position:absolute;top:0;pointer-events:none}#log{overflow-y:scroll;height:4.5em;line-height:1.5em}#log li{display:block}.mushroom{cursor:pointer}.b{font-weight:bold}</style>
</head><body>
<ol id="log" reversed></ol>
<div id="wrap">
<canvas id="canvas" moz-opaque></canvas>
<canvas id="cover"></canvas>
</div>
<p>Luck: <span id="luck"></span><br>
<canvas id="luck-canvas" moz-opaque></canvas></p>
<p id="inv"></p>
<section>
<h2>Help</h2>
<p>Use number pad to move (or arrow keys but without diagonal movement), hold shift to walk to next wall. Or click on a place to go to (if you have seen it before).</p>
<p>To climb up and down ladders use &lt; and &gt;. Or just click on it.</p>
<p>Press x to automatically explore the map.</p>
<p>Press w to wait a turn, or W to wait until you see an enemy.</p>
<p>To attack an enemy, press f for a ranged attack, or walk into it for a melee attack. Or just click on it.</p>
<p>Press e to eat a mushroom, or click it in your inventory.</p>
</section>
<script>
(function(){var g,w,u,x,y,z,v,t,A,B;g=function(){function c(c,d){var j;k?a.push([c,d]):(j=document.createElement("li"),j.textContent=c.charAt(0).toUpperCase()+c.slice(1),j.className=d||"",b.insertBefore(j,b.firstChild),b.scrollTop=0)}var b=document.getElementById("log"),a=[],k=!1;c.async=function(a){k=a};c.clearQueue=function(){a.forEach(function(a){c(a[0],a[1])});a=[]};return c}();w=function(){function c(a,b){a=Math.ceil(a);b=Math.floor(b);return Math.floor(a+Math.random()*(b+1-a))}function b(a,
b,d,j){function e(a,b){var k,c;for(k=0;k<a.w;k++)for(c=0;c<a.h;c++)p[c+a.y+1][k+a.x+1]=b}var l,i,r,p=[];for(i=0;i<f+2;i++){r=[];for(l=0;l<k+2;l++)r.push("#");p.push(r)}for(i=0;i<b.length;i++)e(b[i]," ");for(i=0;i<a.length;i++)e(a[i],".");p[j+1][d+1]="<";i=a.length===1?0:c(1,a.length-1);l=c(0,a[i].w-1)+a[i].x;i=c(0,a[i].h-1)+a[i].y;p[i+1][l+1]=">";return p.map(function(a){return a.join("")}).join("\n")}function a(a,b,k){var f,d,l;Math.random()<0.5?(f=a,a=b):f=b;for(b=0;b<j;b++){d=2*c(f.x/2,(f.x+f.w-
1)/2);l=2*c(a.y/2,(a.y+a.h-1)/2);var i;a:{i=k;for(var r=d,p=l,o=void 0,o=0;o<i.length;o++)if((r===i[o].x-1||r===i[o].x+i[o].w)&&i[o].y-1<=p&&p<=i[o].y+i[o].h||(p===i[o].y-1||p===i[o].y+i[o].h)&&i[o].x-1<=r&&r<=i[o].x+i[o].w){i=!0;break a}i=!1}if(!i)break}k={x:d,y:Math.min(f.y,l),w:1,h:Math.abs(f.y-l)+1};d={x:Math.min(a.x,d),y:l,w:Math.abs(a.x-d)+1,h:1};return[k,d]}var k=50,f=20,d=0.3*k*f,j=1E4;return function(h,j){h===-1?(h=c(0,k-1),j=c(0,f-1)):(h--,j--);var g=[],m,e,l;a:{m=h;l=j;var i;for(e=0;e<
1E4;e++)if(i={x:c(0,m),y:c(0,l),w:c(4,12),h:c(4,8)},i.x+i.w<=k&&i.y+i.h<=f&&i.x+i.w>m&&i.y+i.h>l){e=i;break a}e={x:m,y:l,w:1,h:1}}l=e.w*e.h;g.push(e);for(m=0;m<1E4;m++){a:{e=g;var r=i=void 0;i={x:c(0,k-4),y:c(0,f-4),w:c(4,12),h:c(4,8)};if(!(i.x+i.w>k)&&!(i.y+i.h>f)){for(r=0;r<e.length;r++){var p;p=e[r];var o=i;p=Math.abs(p.x-o.x)>(p.x<o.x?p.w:o.w)?!1:Math.abs(p.y-o.y)>(p.y<o.y?p.h:o.h)?!1:!0;if(p){e=void 0;break a}}e=i}else e=void 0}if(e&&(l+=e.w*e.h,g.push(e),l>=d))break}l=[];for(m=1;m<g.length;m++)l=
l.concat(a(g[c(0,m-1)],g[m],g));return b(g,l,h,j)}}();u=function(){function c(b){this.canvas=document.getElementById(b);this.ctx=this.canvas.getContext("2d",{alpha:!1});this.cover=document.getElementById("cover");this.coverCtx=this.cover.getContext("2d");this.f=1.5}c.animations=[];c.addAnimation=function(b,a,k,f,d){c.animations.push({x0:b,y0:a,x1:k,y1:f,h:d})};c.prototype.loadSprites=function(b){var a=new Image;this.sprites=[];a.onload=function(){var k,c,d;for(k=0;k<18;k++)c=document.createElement("canvas"),
c.width=16,c.height=16,d=c.getContext("2d"),d.drawImage(a,k*16,0,16,16,0,0,16,16),this.sprites.push(c);b()}.bind(this);a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASAAAAAQCAMAAACBUFKrAAAAAXNSR0IArs4c6QAAAEhQTFRFAAAAAHcAiACIiEQAu2YAzAAA3d0AAAAAAHcAAKoAQh8fREREXywRZgBmiAAAiACIiEQAiIiIqgCqu2YAzAAAzMzM3d0A////Qvs0+AAAAAd0Uk5TAAAAAAAAAFVk6lgAAAABYktHRBcL1piPAAADwUlEQVRYw62YAXujIAyG2UmLnTeEyur//6eXkEAC4ub2XKwiSm3z9ksINZ+dvYPlAx0/vzND5r1pbEYzJ2YDmrV/zgYYuD3pvgMzl20wuL/S91M6e9hvAf3lnfmk3bd4Ho+HJvRctfcbGiBqkYSm0xC6AEhGuOPo/krfT+mU0FVABUjtozEg7/EDlIgQDxISPs91VXyQEOyKUAiv1ytogg2hKwoqQ9wRkEsOXu3j9JCUzgl9F0I7WQVS+6Igv+/0CZ7VcwD0REBMKJB6qKlBBtCEUNhm2BSggc9DQI7aNBKMuuIImBM+Lr8uKkjr5/0dYCQNpO/n8AJAeffI50EBlmNsLnwQ0Cp89IkGZIWhBoRXgvrSMcYzQq7YTW7kHwQe0fLSgHoJpV8AWpaFACWkISHm6eGkIk/i4RQ0Uxp6FkArkWBf5YyCCqIsCI6vAKG7I0Tk85HQFtCzsJ0p6kYu3Bo+hddFQEsGsgCglDdRkE/KGNAjs+EoewqgtXG1OaW0Q7177kx3vgebURncbCQwIuTqoWahSqh4HMi1oEMsdSHmdIiljCdpQDGe5SACsmQFLcshxCDAKh645SW6OA09NaB1DIjoVAj3O05idwVI/+AbQyJCeF3PX1kRzi1KQ64AEo7JqSSUcgJqkpAKuB5QIx84cEgdAXGI+RJfOwOaOwUxmQ8y1IqKq6BzTsXzlquotzdCFEKXM6aJU3zso4XOgA8AWiqhDpBzRUH0vpSKgoTQEVAzzbeAuhA7KKgmII6xueQgLoU0IK2bOs9zyilfDvnktwKhfLvmXccZJeOBkwzoBVtT/9xu7nPRGmoBOScKwuEpiYKYSsoZKF0GtLdJupvmfWNcRHOU0SwmgEq+Ke2Ij7mX6JwLIEZEqcYGh3zs1E1JFSEDIkIjQJKDCJDkoCKb3KZrdVBXH9a+LhRh3t33qAtp9pD7BVCTeoqA2viSd2dCAwVRio5xSMgQIKCzEKV4TNK1FjAlxEqh2FRC6etpvh5OATVLjQbQLBlaCCk+gQHl9sBn2ypf0AkRJIc2Ts+TtXhqj4B41kZCiKhc+hUg8z8BRYy6WPnwYkytxRCQUTOW5dZIK4BopQv6YUCiIfyIyViwvkpWAwohmd++q4N+tNQYABrHnQ4xBahUz91qfv3QZR46aMu0Hho+tJTD1crMtWDAacxE9t/alk+Xg2IV0c3FGzSjSpprA6k1c9WThuX5lRx0YTUfa/F//ifHqYXDBSiUca91EDrDzmc4ipCESj6JGluUQVHdO/YBTt4H9g+EQKBD86srFQAAAABJRU5ErkJggg=="};
c.prototype.setSize=function(b,a){if(this.canvas.width!==b*16)this.canvas.width=b*16,this.canvas.style.width=b*16*this.f+"px",this.cover.width=b*16,this.cover.style.width=b*16*this.f+"px";if(this.canvas.height!==a*16)this.canvas.height=a*16,this.canvas.style.height=a*16*this.f+"px",this.cover.height=a*16,this.cover.style.height=a*16*this.f+"px"};c.prototype.getTile=function(b,a){var k=this.canvas.getBoundingClientRect(),b=(b-k.left)/this.f,a=(a-k.top)/this.f,b=Math.floor(b/16),a=Math.floor(a/16);
return[b,a]};c.prototype.showTarget=function(b,a,k){b=b*16+8;a=a*16+8;this.coverCtx.fillStyle="rgba(255,255,255,0.75)";this.coverCtx.fillRect(b,a,8,8);this.coverCtx.font="10px monospace";this.coverCtx.textAlign="center";this.coverCtx.fillStyle="#000";this.coverCtx.fillText(k,b+4,a+8)};c.prototype.clearTargets=function(){this.coverCtx.clearRect(0,0,this.cover.width,this.cover.height)};c.prototype.showAnimation=function(b,a,k,c,d,j){var h;h=j*Math.PI*4;d&&(j=j>0.5?2-2*j:2*j);b+=(k-b)*j;a+=(c-a)*j;this.coverCtx.save();
this.coverCtx.translate(b*16+8,a*16+8);this.coverCtx.rotate(h);this.coverCtx.drawImage(this.sprites[d?7:17],-8,-8);this.coverCtx.restore()};c.prototype.runAnimations=function(){var b=window.requestAnimationFrame||window.mozRequestAnimationFrame,a,k;c.animations.length!==0&&(k=function(f){var d,j;a||(a=f);this.clearTargets();d=(f-a)/200;if(d<=1){for(f=0;f<c.animations.length;f++)j=c.animations[f],this.showAnimation(j.x0,j.y0,j.x1,j.y1,j.h,d);b(k)}else c.animations=[]}.bind(this),b(k))};return c}();
x=function(){function c(b){this.type=b;this.seen=!1}c.draw={".":function(b){b.fillStyle="rgba(128,128,128,0.75)";b.fillRect(0,0,16,16)}," ":function(b,a){b.drawImage(a[0],0,0)},"#":function(b,a){b.drawImage(a[1],0,0)},">":function(b,a){b.drawImage(a[2],0,0)},"<":function(b,a){b.drawImage(a[3],0,0)},F:function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[4],0,0)},"%":function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[5],0,0)},"*":function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[6],0,0)},")":function(b,
a){b.drawImage(a[0],0,0);b.drawImage(a[7],0,0)},"(":function(b,a){b.drawImage(a[0],0,0);b.drawImage(a[8],0,0)}};c.prototype.draw=function(b,a){if(a)this.seen=!0;if(this.seen&&(c.draw[this.type](b.ctx,b.sprites),!a))c.draw["."](b.ctx)};c.prototype.isOpen=function(){return this.type!=="#"};c.prototype.isSeen=function(){return this.seen};c.prototype.getType=function(){return this.type};c.prototype.takeItem=function(b){this.type=b||" "};return c}();y=function(){function c(a,b){this.tiles=a.split("\n").map(function(a){return a.split("").map(function(a){return new x(a)})});
this.npc=[];this.depth=b}function b(a,b,c,d,j){function h(c,d,f){for(var c={x:c,y:d,prev:f,g:f?f.g+1:0,h:Math.max(Math.abs(c-a),Math.abs(d-b))},e,f=c.g+c.h,d=0;d<g.length;d++)if(e=g[d].g+g[d].h,f<e||f===e&&c.h<g[d].h){g.splice(d,0,c);return}g.push(c)}var g=[],q={},m,e;for(h(c,d);g.length;)if(c=g.shift(),d=c.x+","+c.y,!q[d]){q[d]=c;if(c.x===a&&c.y===b)break;m=j(c.x,c.y);for(e=0;e<m.length;e++)d=m[e][0]+","+m[e][1],q[d]||h(m[e][0],m[e][1],c)}if(c=q[a+","+b]){for(j=[];c;)j.push([c.x,c.y]),c=c.prev;return j}}
c.prototype.draw=function(a,b){var c=this.tiles.length,d=this.tiles[0].length,j,h,s=!1;a.setSize(d,c);a.ctx.fillStyle="#000";a.ctx.fillRect(0,0,d*16,c*16);for(j=0;j<d;j++)for(h=0;h<c;h++)a.ctx.save(),a.ctx.translate(j*16,h*16),this.tiles[h][j].draw(a,b.canSee(j,h)),a.ctx.restore();this.visibleMonsters=[];for(c=0;c<this.npc.length;c++)d=this.npc[c],j=d.x,h=d.y,b.canSee(j,h)?(a.ctx.save(),a.ctx.translate(j*16,h*16),d.draw(a),a.ctx.restore(),d.seen||g(d.seenBefore?"you see "+d.getDesc(!0)+" again.":
"you see "+d.getDesc()+"."),d.seen=!0,s=d.seenBefore=!0,this.visibleMonsters.push(d)):d.seen=!1;a.ctx.save();a.ctx.translate(b.x*16,b.y*16);b.draw(a);a.ctx.restore();b.showLuck();return s};c.prototype.isOpen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isOpen()};c.prototype.hasBeenSeen=function(a,b){return a<0||a>=this.tiles[0].length||b<0||b>=this.tiles.length?!1:this.tiles[b][a].isSeen()};c.prototype.getType=function(a,b){return this.tiles[b][a].getType()};
c.prototype.takeItem=function(a,b,c){return this.tiles[b][a].takeItem(c)};c.prototype.monsterAt=function(a,b){var c,d;for(c=0;c<this.npc.length;c++)if(d=this.npc[c],d.x===a&&d.y===b)return d};c.prototype.findFirst=function(a){var b,c;for(b=0;b<this.tiles[0].length;b++)for(c=0;c<this.tiles.length;c++)if(this.tiles[c][b].getType()===a)return[b,c]};c.prototype.findFreeTile=function(a){var b,c,d;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*this.tiles[0].length),d=Math.floor(Math.random()*this.tiles.length),
this.isOpen(c,d)&&!this.monsterAt(c,d)&&!a.canSee(c,d))return[c,d]};c.prototype.addMonster=function(a,b,c){a.place(b,c,this);this.npc.push(a)};c.prototype.removeMonster=function(a){this.npc.splice(this.npc.indexOf(a),1)};c.prototype.leave=function(){var a;for(a=0;a<this.npc.length;a++)this.npc[a].seen=!1};c.prototype.findPath=function(a,c,f,d,j){var h=this;return b(a,c,f,d,function(a,b){return[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]].map(function(c){return[a+c[0],b+c[1]]}).filter(function(a){return h.isOpen(a[0],
a[1])&&(!j||h.hasBeenSeen(a[0],a[1]))})})};c.prototype.autoexplore=function(a){var b=Infinity,c,d,j,h,g;for(h=0;h<this.tiles[0].length;h++)for(g=0;g<this.tiles.length;g++)this.isOpen(h,g)&&!this.hasBeenSeen(h,g)&&(j=Math.max(Math.abs(a.x-h),Math.abs(a.y-g)),j<b&&(c=h,d=g,b=j));if(b!==Infinity&&(a=this.findPath(a.x,a.y,c,d))){for(b=0;b<a.length;b++)if(!this.hasBeenSeen(a[b][0],a[b][1])){a.length=b+1;break}return a}};return c}();z=function(){function c(){function b(a){var b=Object.keys(a),c,k=0;for(c=
0;c<b.length;c++)k+=a[b[c]];for(c=0;c<b.length;c++)a[b[c]]/=k;return a}var a,c,f;this.levelData=[{items:[],monsters:[]},{items:[],monsters:[]},{items:[],monsters:[]}];this.levelData[Math.floor(Math.random()*2)].items.push("(");this.levelData[Math.floor(Math.random()*2)].items.push(")");this.levelData[Math.floor(Math.random()*2)].items.push("*");this.levelData[Math.floor(Math.random()*2)].items.push("*");for(a=0;a<this.levelData.length;a++){f=2+Math.floor(Math.random()*2);for(c=0;c<f;c++)this.levelData[a].items.push("%");
f=1+Math.floor(Math.random()*2);for(c=0;c<f;c++)this.levelData[a].items.push("F")}for(a=0;a<this.levelData.length;a++)this.levelData[a].monsters.push(":1"),this.levelData[a].monsters.push((a+1)*Math.random()<1?":1":":2"),a===1&&this.levelData[a].monsters.push(Math.random()<0.5?"&1":"n"),a>=1&&this.levelData[a].monsters.push(Math.random()<0.5?"f1":"B1"),this.levelData[a].monsterProbs=b({":1":3,":2":2,":3":1,f1:a-1,f2:(a-1)/2,f3:(a-1)/4,B1:a-1,B2:(a-1)/2,B3:(a-1)/4,n:2,"&1":1});this.levels=[this.createLevel(3,
3,0)];this.currentLevel=0;this.henchmen=[];this.maxHenchmen=1}c.prototype.init=function(b){b.place(3,3,this.levels[0]);b.missedEarlyLuckyCharms=2;this.initMonsters(b)};c.prototype.createLevel=function(b,a,c){function f(a){var b,c;for(b=0;b<1E4;b++)if(c=Math.floor(Math.random()*d.length),d.charAt(c)==="."){d=d.slice(0,c)+a+d.slice(c+1);return}d=d.replace(/./,a)}for(var d=w(b,a),b=0;b<this.levelData[c].items.length;b++)f(this.levelData[c].items[b]);d=d.replace(/\./g," ");c===0?d=d.replace("<"," "):
c===this.levelData.length-1&&(d=d.replace(">"," "));return new y(d,c)};c.prototype.goUp=function(b){g("you climb up the ladder.");this.levels[this.currentLevel].leave();this.currentLevel--;b.level=this.levels[this.currentLevel]};c.prototype.goDown=function(b){var a;g("you climb down the ladder.");this.levels[this.currentLevel].leave();this.currentLevel++;this.levels[this.currentLevel]||(a=this.createLevel(b.x,b.y,this.currentLevel),this.levels.push(a));b.level=this.levels[this.currentLevel];a&&this.initMonsters(b)};
c.prototype.createHenchman=function(){var b;if(this.henchmen.length===this.maxHenchmen)return new t("n");b=new t("&1");this.henchmen.push(b);b.desc[1]+=this.henchmen.length;return b};c.prototype.createMonster=function(b){return b==="&1"?this.createHenchman():new t(b)};c.prototype.createRandomMonster=function(b){for(var a=Object.keys(b),c=Math.random();a.length>1&&b[a[0]]<c;)c-=b[a[0]],a.shift();return this.createMonster(a[0])};c.prototype.initMonsters=function(b){var a,c=this.levels[this.currentLevel],
f,d;this.currentLevel===2&&(a=c.findFirst("<"),c.isOpen(a[0]-1,a[1])?a[0]--:a[0]++,c.addMonster(new t("@2"),a[0],a[1]));if(this.currentLevel===this.levelData.length-1)a=c.findFreeTile(b),c.addMonster(new t("&2"),a[0],a[1]),this.transferHenchmen(b,c),this.maxHenchmen=2,a=c.findFreeTile(b),c.addMonster(this.createHenchman(),a[0],a[1]);d=this.levelData[this.currentLevel].monsters;for(f=0;f<d.length;f++)(a=c.findFreeTile(b))&&c.addMonster(this.createMonster(d[f]),a[0],a[1])};c.prototype.spawnMonster=
function(b){var a=this.levels[this.currentLevel];Math.random()>0.05||(b=a.findFreeTile(b))&&a.addMonster(this.createRandomMonster(this.levelData[this.currentLevel].monsterProbs),b[0],b[1])};c.prototype.transferHenchmen=function(b,a){var c,f,d,j=!1;if(!this.henchmenTransferred){for(c=0;c<this.henchmen.length;c++)if(f=this.henchmen[c],f.health!==0&&(d=a.findFreeTile(b)))f.level.removeMonster(f),a.addMonster(f,d[0],d[1]),j=!0;j&&g("you sense that all of Lord Balsekil\u2019s henchmen rushed to his help.",
"b");this.henchmenTransferred=!0}};return c}();v=function(){function c(){}c.draw={"@":function(b,a){b.drawImage(a[9],0,0)},"@2":function(b,a){b.drawImage(a[10],0,0)},":1":function(b,a){b.drawImage(a[11],0,0)},":2":function(b,a){b.drawImage(a[11],0,0)},":3":function(b,a){b.drawImage(a[11],0,0)},f1:function(b,a){b.drawImage(a[12],0,0)},f2:function(b,a){b.drawImage(a[12],0,0)},f3:function(b,a){b.drawImage(a[12],0,0)},B1:function(b,a){b.drawImage(a[13],0,0)},B2:function(b,a){b.drawImage(a[13],0,0)},B3:function(b,
a){b.drawImage(a[13],0,0)},n:function(b,a){b.drawImage(a[14],0,0)},"&1":function(b,a){b.drawImage(a[15],0,0)},"&2":function(b,a){b.drawImage(a[16],0,0)}};c.prototype.init=function(b){this.health=b.health||10;this.maxHealth=b.health||10;this.experience=b.experience||1;this.block=b.block||0.1;this.minAttack=b.minAttack||1;this.maxAttack=b.maxAttack||2;if(b.speed)this.speed=1/b.speed;this.aiMode=b.aiMode;if(b.desc)this.desc=JSON.parse(JSON.stringify(b.desc));this.attackName=b.attackName};c.prototype.place=
function(b,a,c){this.x=b;this.y=a;this.level=c};c.prototype.drawHealth=function(b,a,c){var f=this.health/this.maxHealth,d;d="hsl("+Math.round(140*f*f)+",100%,30%)";b.fillStyle=d;b.fillRect(0,0,a,c);b.fillStyle="#000";f=Math.round((a-2)*(1-f));b.fillRect(a-f-1,1,f,c-2);return d};c.prototype.draw=function(b){c.draw[this.type](b.ctx,b.sprites);!this.isPlayer&&this.health<this.maxHealth&&(b.ctx.translate(2,2),this.drawHealth(b.ctx,12,4))};c.prototype.moveTo=function(b,a){var c;this.x=b;this.y=a;this.isPlayer&&
(c=this.level.getType(b,a),c!==" "&&(c=this.handleItem(c))&&this.level.takeItem(b,a))};c.prototype.moveRel=function(b,a){var c=this.x+b,f=this.y+a,d;if(d=this.level.monsterAt(c,f))return this.attack(d),!0;return this.level.isOpen(c,f)?(this.moveTo(c,f),!0):!1};c.prototype.rangedFails=function(b){return Math.random()<(Math.pow(1.3,b/2)-1)/this.experience};c.prototype.blockAttack=function(){return Math.random()<this.block*this.experience*(this.hasHorseshoe&&!this.usesHorseshoe?3:1)};c.prototype.getAttackDamage=
function(){return Math.round((this.minAttack+Math.random()*(this.maxAttack-this.minAttack))*this.experience)};c.prototype.improveExperience=function(b){this.luckyMushroomTimeout&&(this.experience/=2);b=this.experience*Math.pow(2,b/500);b>2&&(b=2);Math.floor(b*10)!==Math.floor(this.experience*10)&&g("you feel more experienced now.","b");this.experience=b;this.luckyMushroomTimeout&&(this.experience*=2)};c.prototype.getAttackName=function(b,a){var c;return this.isPlayer?(c=b?this.hasHorseshoe?"throw your horseshoe at":
"yell your lucky number at":"hit",a&&(c="try to "+c),"you "+c+" "):(c=this.attackName?this.attackName[a?0:1]:a?"tries to attack":"attacks",this.getDesc(!0)+" "+c+" ")};c.prototype.attack=function(b,a){function c(a,b){var k=a.x-b.x,h=a.y-b.y;return Math.sqrt(k*k+h*h)}b.health!==0&&(a&&u.addAnimation(this.x,this.y,b.x,b.y,this.hasHorseshoe),a&&this.rangedFails(c(b,this))?this.isPlayer?g(this.getAttackName(!0,!0)+b.getDesc(!0)+", but miss."):g(this.getAttackName(!0,!0)+"you, but misses."):a&&this.hasHorseshoe&&
b.type==="n"?(g("uh-oh! The mirror-monster shatters!","b"),b.level.removeMonster(b),this.reduceHealth(20)):b.blockAttack()?this.isPlayer?g(this.getAttackName(a,!0)+b.getDesc(!0)+", but your attack is blocked."):g(this.getAttackName(a,!0)+"you, but you block the attack."):(this.isPlayer?g(this.getAttackName(a)+b.getDesc(!0)+"."):(g(this.getAttackName(a)+"you."),this.type.charAt(0)==="B"&&Math.random()<0.2&&(g(this.getDesc(!0)+" hits your eyes."),b.makeBlind())),b.reduceHealth(this.getAttackDamage())&&
this.isPlayer&&this.improveExperience(b.maxHealth)))};c.prototype.reduceHealth=function(b){this.health-=b;if(this.health<=0)return this.health=0,this.die(),!0};c.prototype.die=function(){this.isPlayer?g("you are out of luck and lose the game.","b"):(g(this.getDesc(!0)+" vanishes.","b"),this.type==="&2"&&(this.level.takeItem(this.x,this.y,"*"),g(this.getDesc(!0)+" left back a lucky charm!","b")),this.level.removeMonster(this))};return c}();t=function(){function c(b){this.type=b;this.seenBefore=this.seen=
!1;this.init(c.data[b])}c.prototype=new v;c.data={":1":{desc:["a small newt","the small newt"],attackName:["tries to touch","touches"],speed:0.5,maxAttack:1,health:5},":2":{desc:["a newt","the newt"],attackName:["tries to touch","touches"],speed:0.75},":3":{desc:["a large newt","the large newt"],attackName:["tries to touch","touches"]},B1:{desc:["a small crow","the small crow"],attackName:["tries to peck","pecks"],maxAttack:1,health:5},B2:{desc:["a crow","the crow"],attackName:["tries to peck","pecks"],
speed:1.25,maxAttack:1,health:5},B3:{desc:["a large crow","the large crow"],attackName:["tries to peck","pecks"],speed:1.5,health:5},f1:{desc:["a small black cat","the small black cat"],attackName:["tries to hiss at","hisses at"],maxAttack:1,aiMode:"ranged"},f2:{desc:["a black cat","the black cat"],attackName:["tries to hiss at","hisses at"],maxAttack:1,aiMode:"ranged"},f3:{desc:["a large black cat","the large black cat"],attackName:["tries to hiss at","hisses at"],aiMode:"ranged"},n:{desc:["a mirror monster",
"the mirror monster"],attackName:["tries to cast an evil look at","casts an evil look at"],aiMode:"ranged",block:0},"&1":{desc:["one of Balsekil\u2019s henchmen","Henchman No. "],aiMode:"meleeRanged",block:0.15,health:15,minAttack:1,maxAttack:3},"&2":{desc:["Lord Balsekil","Lord Balsekil"],aiMode:"meleeRanged",block:0.2,health:25,minAttack:1,maxAttack:5,experience:1.5},"@2":{desc:["a chimney sweep","the chimney sweep"],aiMode:"hint",block:1}};c.prototype.getDesc=function(b){return this.desc[b?1:0]};
c.prototype.walkRandom=function(b){var a,c;do a=Math.floor(Math.random()*3)-1,c=Math.floor(Math.random()*3)-1;while(!this.level.isOpen(this.x+a,this.y+c));!this.level.monsterAt(this.x+a,this.y+c)&&!(b.x===this.x+a&&b.y===this.y+c)&&this.moveRel(a,c)};c.prototype.huntPlayer=function(b){var a=this.level.findPath(this.x,this.y,b.x,b.y);!a||a.length<2||this.level.monsterAt(a[1][0],a[1][1])?this.walkRandom(b):this.moveRel(a[1][0]-a[0][0],a[1][1]-a[0][1])};c.prototype.meleeAI=function(b){Math.abs(b.x-this.x)<=
1&&Math.abs(b.y-this.y)<=1?this.attack(b):this.seen?this.huntPlayer(b):this.walkRandom(b)};c.prototype.rangedAI=function(b){this.seen?this.attack(b,!0):Math.random()<0.5?this.walkRandom(b):this.huntPlayer(b)};c.prototype.meleeRangedAI=function(b){var a=b.x-this.x,c=b.y-this.y;Math.abs(a)<=1&&Math.abs(c)<=1?this.attack(b):a*a+c*c<=4?this.attack(b,!0):this.seen?Math.random()<0.5?this.attack(b,!0):this.huntPlayer(b):this.rangedAI(b)};c.prototype.hintAI=function(b){var a;if(this.seen)a=b.getHint(),this.lastHint!==
a?(g(this.getDesc(!0)+": \u201c"+a+"\u201d","b"),this.lastHint=a):this.walkRandom(b)};c.prototype.monsterAI=function(b){if(this.seenBefore)switch(this.aiMode){case "ranged":this.rangedAI(b);break;case "meleeRanged":this.meleeRangedAI(b);break;case "hint":this.hintAI(b);break;default:this.meleeAI(b)}};return c}();A=function(){function c(a){this.type="@";this.isPlayer=!0;this.dungeon=a;a.init(this);this.sightRadius=4;this.init({health:77,maxAttack:2});this.maxDepth=this.steps=0;this.hasHorseshoe=this.hasLamp=
!1;this.luckyMushroomTimeout=this.luckyMushrooms=this.luckyCharms=0;this.blind=!1;this.blindTimeout=0}function b(a,b,c,d,g){for(var h=a,s=b,q=Math.abs(c-a),a=a<c?1:-1,m=-Math.abs(d-b),b=b<d?1:-1,e=q+m,l;h!==c||s!==d;){if(!g(h,s))return!1;l=e*2;l>m&&(e+=m,h+=a);l<q&&(e+=q,s+=b)}return!0}c.prototype=new v;c.prototype.showLuck=function(){if(!this.luckOutput)this.luckOutput=document.getElementById("luck"),this.luckCanvas=document.getElementById("luck-canvas").getContext("2d",{alpha:!1}),this.luckCanvas.canvas.width=
100,this.luckCanvas.canvas.height=10;this.luckOutput.style.color=this.drawHealth(this.luckCanvas,100,10);this.luckOutput.textContent=this.health+"/"+this.maxHealth};c.prototype.showInv=function(){var a;a=[this.luckyCharms?this.luckyCharms+" lucky charm(s)":"",this.luckyMushrooms?'<span class="mushroom">'+this.luckyMushrooms+" lucky mushroom(s)</span>":"",this.hasLamp?"a flashlight":"",this.hasHorseshoe?"a horseshoe":""].filter(function(a){return a}).join(", ");document.getElementById("inv").innerHTML=
a?"You have: "+a:""};c.prototype.getHint=function(){return!this.hasHorseshoe?"You should go back and get the horseshoe before proceeding further.":!this.hasLamp?"You should go back and get the flashlight before proceeding further.":this.missedEarlyLuckyCharms===1?"You should go back and get the lucky charm before proceeding further.":this.missedEarlyLuckyCharms?"You should go back and get the "+this.missedEarlyLuckyCharms+" lucky charms before proceeding further.":"Well done so far! Now find and defeat Lord Balsekil who has the third lucky charm."};
c.prototype.getResult=function(){var a=this.experience,b;this.luckyMushroomTimeout&&(a/=2);a=Math.round(100*(a-1));b=this.luckyCharms*1E3+(this.maxDepth+1)*50+Math.round(a/2)+this.health;return"After "+this.steps+" steps you found "+(this.luckyCharms===1?"one lucky charm":(this.luckyCharms||"no")+" lucky charms")+", reached a depth of "+(this.maxDepth+1)+", and increased your experience by "+a+" %. For this you earn "+b+" points."};c.prototype.canSee=function(a,c){var f=a-this.x,d=c-this.y,g=this.level;
this.level.isOpen(a,c)||(f>0?f-=0.5:f<0&&(f+=0.5),d>0?d-=0.5:d<0&&(d+=0.5));return f*f+d*d>this.sightRadius*this.sightRadius?!1:b(this.x,this.y,a,c,function(b,d){return g.isOpen(b,d)||a===b&&c===d})};c.prototype.handleItem=function(a){var b=!1;if(a===">"&&this.level.depth===0)g("you found the ladder down to the second level.");else if(a==="<")Math.random()<0.3&&(g("you accidentally walked below the ladder."),this.reduceHealth(2));else if(a==="%"){a="you found a four-leave clover, ";if(this.health===
this.maxHealth)a+="but you leave it here for later.";else{b=!0;this.health+=7;if(this.health>this.maxHealth)this.health=this.maxHealth;a+="which"+(this.health===this.maxHealth?"":" partially")+" restores your luck."}g(a)}else if(a==="*")this.level.depth<2&&this.missedEarlyLuckyCharms--,this.luckyCharms++,b=!0,g("you found a lucky charm.","b");else if(a==="F")this.luckyMushrooms++,b=!0,g("you found a lucky mushroom"+(this.luckyMushrooms===1?", which you can eat to make you very strong for a short time":
"")+".",this.luckyMushrooms===1?"b":"");else if(a==="("){this.hasLamp=b=!0;if(!this.blind)this.sightRadius=6;g("you found a flashlight.","b")}else if(a===")")this.hasHorseshoe=b=!0,this.minAttack=2,this.maxAttack=4,g("you found a horseshoe. From now on you will use it for attacks (it will return like a boomerang), and to defend attacks (but only if you did not just throw it).","b");b&&this.showInv();return b};c.prototype.eat=function(){if(this.luckyMushrooms===0)return!1;this.luckyMushrooms--;this.showInv();
this.luckyMushroomTimeout===0&&(this.experience*=2,g("you feel very strong!","b"));this.luckyMushroomTimeout+=Math.floor(4+Math.random()*5);return!0};c.prototype.makeBlind=function(){if(this.blindTimeout===0)this.blind=!0,this.sightRadius=1.5,g("you can hardly see!");this.blindTimeout+=Math.floor(6+Math.random()*8)};c.prototype.handleTimeouts=function(){this.luckyMushroomTimeout>0&&(this.luckyMushroomTimeout--,this.luckyMushroomTimeout===0&&(this.experience/=2,g("you feel normal again.","b")));if(this.blindTimeout>
0&&(this.blindTimeout--,this.blindTimeout===0))this.sightRadius=this.hasLamp?6:4,g("your eyes are better again.")};c.prototype.goUp=function(){if(this.level.getType(this.x,this.y)==="<")return this.dungeon.goUp(this),!0};c.prototype.goDown=function(){if(this.level.getType(this.x,this.y)===">")return this.dungeon.goDown(this),this.maxDepth=Math.max(this.maxDepth,this.level.depth),!0};return c}();B=function(){function c(a,b,c){var d;if(c){c=e.x+a;for(d=e.y+b;e.level.isOpen(c,d);)h.push(["move",a,b]),
c+=a,d+=b}else h.push(["move",a,b])}function b(a){var b,c,d;for(b=0;b<a.length;b++)b>0&&h.push(["move",a[b][0]-c,a[b][1]-d]),c=a[b][0],d=a[b][1]}function a(a){var b;for(b=0;b<(a?10:1);b++)h.push(["wait"]);a&&h.push(["autowait"])}function k(b){var d;if(!b.ctrlKey&&!b.altKey){if(b.key&&b.key!=="Unidentified")d={Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown"}[b.key]||b.key;else if(!(d={12:"Clear",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",
40:"ArrowDown"}[b.which])){d=b.shiftKey;var e=String.fromCharCode(b.which).toLowerCase();d&&(e={"<":">"}[e]||e.toUpperCase());d=e}h=[];q&&(q[d]&&h.push(q[d]),q=!1,i.clearTargets(),d="");switch(d){case "1":case "End":c(-1,1,b.shiftKey);break;case "2":case "ArrowDown":c(0,1,b.shiftKey);break;case "3":case "PageDown":c(1,1,b.shiftKey);break;case "4":case "ArrowLeft":c(-1,0,b.shiftKey);break;case "5":case "Clear":case "w":case "W":a(b.shiftKey);break;case "6":case "ArrowRight":c(1,0,b.shiftKey);break;
case "7":case "Home":c(-1,-1,b.shiftKey);break;case "8":case "ArrowUp":c(0,-1,b.shiftKey);break;case "9":case "PageUp":c(1,-1,b.shiftKey);break;case "<":h.push(["goUp"]);break;case ">":h.push(["goDown"]);break;case "e":h.push(["eat"]);break;case "f":h.push(["attack"]);break;case "x":h.push(["autoexplore"])}b.preventDefault();j()}}function f(a){var c,d,f;l||(c=i.getTile(a.clientX,a.clientY),a=c[0],c=c[1],h=[],e.level.hasBeenSeen(a,c)?e.level.isOpen(a,c)?e.canSee(a,c)&&e.level.monsterAt(a,c)?Math.abs(a-
e.x)<=1&&Math.abs(c-e.y)<=1?h.push(["move",a-e.x,c-e.y]):h.push(["attack",a,c]):e.x===a&&e.y===c?(d=e.level.getType(a,c),d!=="<"&&d!==">"&&h.push(["wait"])):(d=e.level.getType(a,c),f=e.level.findPath(e.x,e.y,a,c,!0)):g("you cannot go there."):g("you don\u2019t know how to go there."),f&&b(f),d===">"?h.push(["goDown"]):d==="<"&&h.push(["goUp"]),j())}function d(a){a.target.className==="mushroom"&&(h.push(["eat"]),j())}function j(){var c,d=!1,f,k,n;for(clearTimeout(s);!d;){if(h.length===0)return;c=h.shift();
if(l)return;switch(c[0]){case "move":d=e.moveRel(c[1],c[2]);break;case "goUp":d=e.goUp();break;case "goDown":d=e.goDown();break;case "eat":d=e.eat();break;case "attack":if(c[1])for(f=0;f<e.level.visibleMonsters.length;f++)if(n=e.level.visibleMonsters[f],n.x===c[1]&&n.y===c[2])break;else n=null;else if(e.level.visibleMonsters.length>1){q={};for(f=0;f<e.level.visibleMonsters.length;f++)n=e.level.visibleMonsters[f],k=f<9?String(f+1):String.fromCharCode(97+f-9),q[k]=["attack",n.x,n.y],i.showTarget(n.x,
n.y,k);n=null;g("pick the target (1\u2013"+k+").")}else n=e.level.visibleMonsters[0];if(n){e.attack(n,!0);if(e.hasHorseshoe)e.usesHorseshoe=!0;d=!0}break;case "wait":d=!0;break;case "autowait":g("still waiting, press c to cancel.");a(!0);break;case "autoexplore":(c=e.level.autoexplore(e))?(b(c),h.push(["autoexplore"])):g("level completely explored.")}}g.async(!0);e.steps++;e.dungeon.spawnMonster(e);for(f=0;f<e.level.npc.length;f++)if(n=e.level.npc[f],n.speed)for(n.movesLeft=(n.movesLeft||0)+1;n.movesLeft>=
n.speed;)n.monsterAI(e),n.movesLeft-=n.speed;else n.monsterAI(e);e.handleTimeouts();e.usesHorseshoe=!1;g.async(!1);d=e.level.draw(i,e);i.runAnimations();g.clearQueue();d&&(h=[]);e.health===0&&(h=[],l=!0);e.luckyCharms===3&&(g("you found all lucky charms and win the game.","b"),l=!0);l&&g(e.getResult());h.length>0&&(s=setTimeout(j,m))}var h=[],s,q,m=200,e,l=!1,i=new u("canvas");return{init:function(a){i.loadSprites(function(){e=a;document.addEventListener("keydown",k);i.canvas.addEventListener("click",
f);document.getElementById("inv").addEventListener("click",d);e.level.draw(i,e);g("welcome. Find all three lucky charms to win.","b")})}}}();(function(){var c=new z,c=new A(c);B.init(c)})()})();
</script>
</body></html>